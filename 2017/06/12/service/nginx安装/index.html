<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="L6Lm9d5Crl"/>
  
  
  

  
  <title>nginx安装 | Linux运维装逼指南</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一. rpm包安装1.1 配置nginx 官方yum源用以安装最新稳定版　　用以下内容为模板，创建nginx软件源文件: “/etc/yum.repos.d/nginx.repo”  12345[nginx]name=nginx repobaseurl=http://nginx.org/packages/OS/OSRELEASE/$basearch/gpgcheck=0enabled=1 　　其中">
<meta name="keywords" content="nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx安装">
<meta property="og:url" content="http://www.unix-like.com/2017/06/12/service/nginx安装/index.html">
<meta property="og:site_name" content="Linux运维装逼指南">
<meta property="og:description" content="一. rpm包安装1.1 配置nginx 官方yum源用以安装最新稳定版　　用以下内容为模板，创建nginx软件源文件: “/etc/yum.repos.d/nginx.repo”  12345[nginx]name=nginx repobaseurl=http://nginx.org/packages/OS/OSRELEASE/$basearch/gpgcheck=0enabled=1 　　其中">
<meta property="og:image" content="http://www.unix-like.com/2017/06/12/images/service/nginx/1-1.jpg">
<meta property="og:updated_time" content="2017-06-12T14:33:31.130Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nginx安装">
<meta name="twitter:description" content="一. rpm包安装1.1 配置nginx 官方yum源用以安装最新稳定版　　用以下内容为模板，创建nginx软件源文件: “/etc/yum.repos.d/nginx.repo”  12345[nginx]name=nginx repobaseurl=http://nginx.org/packages/OS/OSRELEASE/$basearch/gpgcheck=0enabled=1 　　其中">
<meta name="twitter:image" content="http://www.unix-like.com/2017/06/12/images/service/nginx/1-1.jpg">
  
    <link rel="alternative" href="/atom.xml" title="Linux运维装逼指南" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  <link rel="stylesheet" href="/css/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: true
      }
  </script>
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <script src="/js/require-2.1.6-jquery-1.9.1.min.js"></script>
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/avatar.png" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">Linux运维装逼指南</a></h1>
        </hgroup>

        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder=" Search...">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>

                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a rel="external nofollow" href="/archives/">所有文章</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/database">数据库</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/python">编程</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/system">操作系统</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/security">安全</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/service">应用服务</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/CG">CG</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/life">生活随笔</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" rel="external nofollow" target="_blank" href="https://github.com/unix-like" title="github">github</a>
                            
                                <a class="fl rss" rel="external nofollow" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>

                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/bash/" style="font-size: 15px;">bash</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/kvm/" style="font-size: 10px;">kvm</a> <a href="/tags/logrotate/" style="font-size: 10px;">logrotate</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/mysql/" style="font-size: 20px;">mysql</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/openvpn/" style="font-size: 15px;">openvpn</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/samba/" style="font-size: 10px;">samba</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/tc/" style="font-size: 10px;">tc</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/字符集/" style="font-size: 10px;">字符集</a> <a href="/tags/数据恢复/" style="font-size: 10px;">数据恢复</a> <a href="/tags/职业/" style="font-size: 15px;">职业</a> <a href="/tags/调优/" style="font-size: 20px;">调优</a>
                    </div>
                </section>
                

                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">一个做运维的人!</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Linux运维装逼指南</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/avatar.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Linux运维装逼指南</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/categories/database">数据库</a></li>
                
                    <li><a href="/categories/python">编程</a></li>
                
                    <li><a href="/categories/system">操作系统</a></li>
                
                    <li><a href="/categories/security">安全</a></li>
                
                    <li><a href="/categories/service">应用服务</a></li>
                
                    <li><a href="/categories/CG">CG</a></li>
                
                    <li><a href="/categories/life">生活随笔</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/unix-like" title="github">github</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-service/nginx安装" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a rel="external nofollow" href="/2017/06/12/service/nginx安装/" class="article-date">
      <time datetime="2017-06-12T14:21:40.000Z" itemprop="datePublished">2017-06-12</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      nginx安装
    </h1>
  


      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/service/">service</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="一-rpm包安装"><a href="#一-rpm包安装" class="headerlink" title="一. rpm包安装"></a>一. rpm包安装</h1><h2 id="1-1-配置nginx-官方yum源用以安装最新稳定版"><a href="#1-1-配置nginx-官方yum源用以安装最新稳定版" class="headerlink" title="1.1 配置nginx 官方yum源用以安装最新稳定版"></a>1.1 配置nginx 官方yum源用以安装最新稳定版</h2><p>　　用以下内容为模板，创建nginx软件源文件: “/etc/yum.repos.d/nginx.repo” </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[nginx]</div><div class="line">name=nginx repo</div><div class="line">baseurl=http://nginx.org/packages/OS/OSRELEASE/$basearch/</div><div class="line">gpgcheck=0</div><div class="line">enabled=1</div></pre></td></tr></table></figure>
<p>　　其中“OS” 用 “centos”替代, 根据不同的系统版本， “OSRELEASE” 用“5”, “6”, 或者“7”替代</p>
<p>　　下面给出一个范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[nginx]</div><div class="line">name=nginx repo</div><div class="line">baseurl=http://nginx.org/packages/centos/6/$basearch/</div><div class="line">gpgcheck=0</div><div class="line">enabled=1</div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="1-2-安装nginx"><a href="#1-2-安装nginx" class="headerlink" title="1.2 安装nginx"></a>1.2 安装nginx</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo yum install nginx</div></pre></td></tr></table></figure>
<h1 id="二-编译安装"><a href="#二-编译安装" class="headerlink" title="二. 编译安装"></a>二. 编译安装</h1><h2 id="2-1-必要软件准备"><a href="#2-1-必要软件准备" class="headerlink" title="2.1 必要软件准备"></a>2.1 必要软件准备</h2><h3 id="2-1-1-安装pcre"><a href="#2-1-1-安装pcre" class="headerlink" title="2.1.1 安装pcre"></a>2.1.1 安装pcre</h3><p>　　为了支持rewrite功能，我们需要安装pcre</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install pcre* //如过你已经装了，请跳过这一步</div></pre></td></tr></table></figure>
<h3 id="2-1-2-安装openssl"><a href="#2-1-2-安装openssl" class="headerlink" title="2.1.2 安装openssl"></a>2.1.2 安装openssl</h3><p>　　需要ssl的支持，如果不需要ssl支持，请跳过这一步</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install openssl*</div></pre></td></tr></table></figure>
<h2 id="2-2-安装nginx"><a href="#2-2-安装nginx" class="headerlink" title="2.2 安装nginx"></a>2.2 安装nginx</h2><h3 id="2-2-1-配置编译参数"><a href="#2-2-1-配置编译参数" class="headerlink" title="2.2.1 配置编译参数"></a>2.2.1 配置编译参数</h3><p>　　执行如下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx-1.5.1 \</div><div class="line">--with-http_ssl_module --with-http_spdy_module \</div><div class="line">--with-http_stub_status_module --with-pcre</div></pre></td></tr></table></figure>
<p>　　–with-http_stub_status_module：支持nginx状态查询</p>
<p>　　–with-http_ssl_module：支持https</p>
<p>　　–with-http_spdy_module：支持google的spdy,想了解请百度spdy,这个必须有ssl的支持</p>
<p>　　–with-pcre：为了支持rewrite重写功能，必须制定pcre</p>
<p>　　最后输出如下内容，表示configure OK了。</p>
<p>…</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">checking <span class="keyword">for</span> zlib library ... found</div><div class="line"> creating objs/Makefile</div><div class="line">Configuration summary</div><div class="line"> + using system PCRE library</div><div class="line"> + using system OpenSSL library</div><div class="line"> + md5: using OpenSSL library</div><div class="line"> + sha1: using OpenSSL library</div><div class="line"> + using system zlib library</div><div class="line">nginx path prefix: <span class="string">"/usr/local/nginx-1.5.1"</span></div><div class="line"> nginx binary file: <span class="string">"/usr/local/nginx-1.5.1/sbin/nginx"</span></div><div class="line"> nginx configuration prefix: <span class="string">"/usr/local/nginx-1.5.1/conf"</span></div><div class="line"> nginx configuration file: <span class="string">"/usr/local/nginx-1.5.1/conf/nginx.conf"</span></div><div class="line"> nginx pid file: <span class="string">"/usr/local/nginx-1.5.1/logs/nginx.pid"</span></div><div class="line"> nginx error <span class="built_in">log</span> file: <span class="string">"/usr/local/nginx-1.5.1/logs/error.log"</span></div><div class="line"> nginx http access <span class="built_in">log</span> file: <span class="string">"/usr/local/nginx-1.5.1/logs/access.log"</span></div><div class="line"> nginx http client request body temporary files: <span class="string">"client_body_temp"</span></div><div class="line"> nginx http proxy temporary files: <span class="string">"proxy_temp"</span></div><div class="line"> nginx http fastcgi temporary files: <span class="string">"fastcgi_temp"</span></div><div class="line"> nginx http uwsgi temporary files: <span class="string">"uwsgi_temp"</span></div><div class="line"> nginx http scgi temporary files: <span class="string">"scgi_temp"</span></div></pre></td></tr></table></figure>
<h3 id="2-2-2-编译nginx"><a href="#2-2-2-编译nginx" class="headerlink" title="2.2.2 编译nginx"></a>2.2.2 编译nginx</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make //确定你的服务器有安装make，如果没有安装请执行yum install make</div></pre></td></tr></table></figure>
<h3 id="2-2-3-安装nginx"><a href="#2-2-3-安装nginx" class="headerlink" title="2.2.3 安装nginx"></a>2.2.3 安装nginx</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make install</div></pre></td></tr></table></figure>
<h2 id="2-3-启动、关闭、重置nginx"><a href="#2-3-启动、关闭、重置nginx" class="headerlink" title="2.3 启动、关闭、重置nginx"></a>2.3 启动、关闭、重置nginx</h2><h3 id="2-3-1-启动：直接执行以下命令-nginx就启动了-不需要改任何配置文件-nginx配置多域名虚拟主机请参考后续文章"><a href="#2-3-1-启动：直接执行以下命令-nginx就启动了-不需要改任何配置文件-nginx配置多域名虚拟主机请参考后续文章" class="headerlink" title="2.3.1 启动：直接执行以下命令,nginx就启动了,不需要改任何配置文件,nginx配置多域名虚拟主机请参考后续文章."></a>2.3.1 启动：直接执行以下命令,nginx就启动了,不需要改任何配置文件,nginx配置多域名虚拟主机请参考后续文章.</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/nginx-1.5.1/sbin/nginx</div></pre></td></tr></table></figure>
<p>　　试试访问：我这边不贴图，直接使用curl命令来读取web信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@ns conf]<span class="comment"># curl -s http://localhost | grep nginx.com</span></div><div class="line">nginx.com.</div></pre></td></tr></table></figure>
<h3 id="2-3-2-关闭："><a href="#2-3-2-关闭：" class="headerlink" title="2.3.2 关闭："></a>2.3.2 关闭：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/nginx-1.5.1/sbin/nginx <span class="_">-s</span> stop</div></pre></td></tr></table></figure>
<h3 id="2-3-3-重置：当你有修改配置文件的时候，只需要reload以下即可"><a href="#2-3-3-重置：当你有修改配置文件的时候，只需要reload以下即可" class="headerlink" title="2.3.3 重置：当你有修改配置文件的时候，只需要reload以下即可"></a>2.3.3 重置：当你有修改配置文件的时候，只需要reload以下即可</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/nginx-1.5.1/sbin/nginx <span class="_">-s</span> reload</div></pre></td></tr></table></figure>
<p>　　整个nginx的编译安装就到这里结束了。</p>
<h1 id="三-从源码打包成rpm包安装"><a href="#三-从源码打包成rpm包安装" class="headerlink" title="三. 从源码打包成rpm包安装"></a>三. 从源码打包成rpm包安装</h1><h2 id="3-1-RPM包的分类"><a href="#3-1-RPM包的分类" class="headerlink" title="3.1 RPM包的分类"></a>3.1 RPM包的分类</h2><p>　　RPM有五种基本的操作功能：安装、卸载、升级、查询和验证。</p>
<p>　　linux软件包分为两大类：</p>
<ol>
<li>二进制类包，包括rpm安装包（一般分为i386和x86等几种）</li>
<li>源码类包，源码包和开发包应该归位此类（.src.rpm）。</li>
</ol>
<p>　　有时候为了方便源码包的安装，和我们自己订制软件包的需求，我们会把一些源码包按照我们的需求来做成rpm包，当有了源码包就可以直接编译得到二进制安装包和其他任意包。spec file是制作rpm包最核心的部分，rpm包的制作就是根据spec file来实现的。在制作自定义rpm包的时候最好不要使用管理员进行,因为管理员权限过大，如果一个命令写错了，结果可能是灾难性的，而制件一个rpm包普通用户完全可以实现</p>
<h2 id="3-2-修改宏及自定义车间位置"><a href="#3-2-修改宏及自定义车间位置" class="headerlink" title="3.2 修改宏及自定义车间位置"></a>3.2 修改宏及自定义车间位置</h2><p>　　在redhat下，rpm包的默认制作路径在/usr/src/redhat下，这其中包含了6个目录（要求全部大写）</p>
<table>
<thead>
<tr>
<th>Directory</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>BUILD</td>
<td>源代码解压以后放的位置，只需提供BUILD目录，具体里面放什么，不用我们管，所以真正的制作车间是BUILD目录</td>
</tr>
<tr>
<td>RPMS</td>
<td>制作完成后的rpm包存放目录，为特定平台指定子目录（i386,i686,ppc）</td>
</tr>
<tr>
<td>SOURCES</td>
<td>收集的源文件，源材料，补丁文件等存放位置</td>
</tr>
<tr>
<td>SPECS</td>
<td>存放spec文件，作为制作rpm包的领岗文件，以 rpm名.spec</td>
</tr>
<tr>
<td>SRPMS</td>
<td>src格式的rpm包位置 ，既然是src格式的包，就没有平台的概念了</td>
</tr>
<tr>
<td>BuiltRoot</td>
<td>假根，使用install临时安装到这个目录，把这个目录当作根来用的，所以在这个目录下的目录文件，才是真正的目录文件。当打包完成后，在清理阶段，这个目录将被删除</td>
</tr>
</tbody>
</table>
<p>　　但centos并没有该目录，因此，我们不得不自定义工作车间，即使在redhat下有该目录，一般也是自定义到普通用户的家目录下的。</p>
<p>　　<code>rpmbuild --showrc</code> 显示所有的宏，以下划线开头，一个下划线：定义环境的使用情况，二个下划线：通常定义的是命令，为什么要定义宏，因为不同的系统，命令的存放位置可能不同，所以通过宏的定义找到命令的真正存放位置。</p>
<p>　　查看默认工作车间，所以只要改变了这个宏，我们就可以自定义工作车间了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># rpmbuild --showrc | grep topdir</span></div><div class="line">-14: _builddir	%&#123;_topdir&#125;/BUILD</div><div class="line">-14: _buildrootdir	%&#123;_topdir&#125;/BUILDROOT</div><div class="line">-14: _rpmdir	%&#123;_topdir&#125;/RPMS</div><div class="line">-14: _sourcedir	%&#123;_topdir&#125;/SOURCES</div><div class="line">-14: _specdir	%&#123;_topdir&#125;/SPECS</div><div class="line">-14: _srcrpmdir	%&#123;_topdir&#125;/SRPMS</div><div class="line">-14: _topdir	%&#123;getenv:HOME&#125;/rpmbuild</div></pre></td></tr></table></figure>
<h2 id="3-3-rpm包制作原理图"><a href="#3-3-rpm包制作原理图" class="headerlink" title="3.3 rpm包制作原理图"></a>3.3 rpm包制作原理图</h2><p><a><img src="../../images/service/nginx/1-1.jpg"></a></p>
<h2 id="3-4-制作rpm包"><a href="#3-4-制作rpm包" class="headerlink" title="3.4 制作rpm包"></a>3.4 制作rpm包</h2><h3 id="3-4-1-安装rpm-build"><a href="#3-4-1-安装rpm-build" class="headerlink" title="3.4.1 安装rpm-build"></a>3.4.1 安装rpm-build</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install rpm-build</div></pre></td></tr></table></figure>
<h3 id="3-4-2-增加普通用户并修改工作车间目录"><a href="#3-4-2-增加普通用户并修改工作车间目录" class="headerlink" title="3.4.2 增加普通用户并修改工作车间目录"></a>3.4.2 增加普通用户并修改工作车间目录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># useradd hero</span></div><div class="line"></div><div class="line"><span class="comment"># su - hero</span></div><div class="line"></div><div class="line">$ vim ~/.rpmmacros</div><div class="line"></div><div class="line">%_topdir        /home/hero/rpmbuild</div><div class="line"></div><div class="line"><span class="comment"># mkdir -pv ~/rpmbuild/&#123;BUILD,RPMS,SOURCES,SPECS,SRPMS&#125;</span></div><div class="line"></div><div class="line"><span class="comment"># rpmbuild --showrc | grep _topdir    #会发现，工作车间已然改变：_topdir    /home/hero/rpmbuild</span></div></pre></td></tr></table></figure>
<h3 id="3-4-3-收集源码文件"><a href="#3-4-3-收集源码文件" class="headerlink" title="3.4.3 收集源码文件"></a>3.4.3 收集源码文件</h3><h4 id="3-4-3-1-文件列表"><a href="#3-4-3-1-文件列表" class="headerlink" title="3.4.3.1 文件列表"></a>3.4.3.1 文件列表</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost SOURCES]<span class="comment"># pwd</span></div><div class="line">/home/hero/rpmbuild/SOURCES</div><div class="line">[root@localhost SOURCES]<span class="comment"># ls</span></div><div class="line">fastcgi_params  nginx  nginx-1.8.1.tar.gz  nginx.conf</div></pre></td></tr></table></figure>
<h4 id="3-4-3-2-nginx-1-8-1-tar-gz-源码包"><a href="#3-4-3-2-nginx-1-8-1-tar-gz-源码包" class="headerlink" title="3.4.3.2 nginx-1.8.1.tar.gz 源码包"></a>3.4.3.2 nginx-1.8.1.tar.gz 源码包</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cp /opt/src/nginx-1.8.1.tar.gz /home/hero/rpmbuild/SOURCES/</div></pre></td></tr></table></figure>
<h4 id="3-4-3-3-nginx启动脚本文件"><a href="#3-4-3-3-nginx启动脚本文件" class="headerlink" title="3.4.3.3 nginx启动脚本文件"></a>3.4.3.3 nginx启动脚本文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># nginx        Startup script for nginx</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># chkconfig: - 85 15</span></div><div class="line"><span class="comment"># processname: nginx</span></div><div class="line"><span class="comment"># config: /etc/nginx/nginx.conf</span></div><div class="line"><span class="comment"># config: /etc/sysconfig/nginx</span></div><div class="line"><span class="comment"># pidfile: /var/run/nginx.pid</span></div><div class="line"><span class="comment"># description: nginx is an HTTP and reverse proxy server</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">### BEGIN INIT INFO</span></div><div class="line"><span class="comment"># Provides: nginx</span></div><div class="line"><span class="comment"># Required-Start: $local_fs $remote_fs $network</span></div><div class="line"><span class="comment"># Required-Stop: $local_fs $remote_fs $network</span></div><div class="line"><span class="comment"># Default-Start: 2 3 4 5</span></div><div class="line"><span class="comment"># Default-Stop: 0 1 6</span></div><div class="line"><span class="comment"># Short-Description: start and stop nginx</span></div><div class="line"><span class="comment">### END INIT INFO</span></div><div class="line"></div><div class="line"><span class="comment"># Source function library.</span></div><div class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -L <span class="variable">$0</span> ]; <span class="keyword">then</span></div><div class="line">    initscript=`/bin/readlink <span class="_">-f</span> <span class="variable">$0</span>`</div><div class="line"><span class="keyword">else</span></div><div class="line">    initscript=<span class="variable">$0</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">sysconfig=`/bin/basename <span class="variable">$initscript</span>`</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="_">-f</span> /etc/sysconfig/<span class="variable">$sysconfig</span> ]; <span class="keyword">then</span></div><div class="line">    . /etc/sysconfig/<span class="variable">$sysconfig</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">nginx=<span class="variable">$&#123;NGINX-/gotwo_data/Application/nginx/sbin/nginx&#125;</span></div><div class="line">prog=`/bin/basename <span class="variable">$nginx</span>`</div><div class="line">conffile=<span class="variable">$&#123;CONFFILE-/gotwo_data/Application/nginx/conf/nginx.conf&#125;</span></div><div class="line">lockfile=<span class="variable">$&#123;LOCKFILE-/gotwo_data/logs/nginx/nginx.lock&#125;</span></div><div class="line">pidfile=<span class="variable">$&#123;PIDFILE-/gotwo_data/logs/nginx/nginx.pid&#125;</span></div><div class="line">SLEEPMSEC=<span class="variable">$&#123;SLEEPMSEC-200000&#125;</span></div><div class="line">UPGRADEWAITLOOPS=<span class="variable">$&#123;UPGRADEWAITLOOPS-5&#125;</span></div><div class="line">RETVAL=0</div><div class="line"></div><div class="line"><span class="function"><span class="title">start</span></span>() &#123;</div><div class="line">    <span class="built_in">echo</span> -n $<span class="string">"Starting <span class="variable">$prog</span>: "</span></div><div class="line"></div><div class="line">    daemon --pidfile=<span class="variable">$&#123;pidfile&#125;</span> <span class="variable">$&#123;nginx&#125;</span> -c <span class="variable">$&#123;conffile&#125;</span></div><div class="line">    RETVAL=$?</div><div class="line">    <span class="built_in">echo</span></div><div class="line">    [ <span class="variable">$RETVAL</span> = 0 ] &amp;&amp; touch <span class="variable">$&#123;lockfile&#125;</span></div><div class="line">    <span class="built_in">return</span> <span class="variable">$RETVAL</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">stop</span></span>() &#123;</div><div class="line">    <span class="built_in">echo</span> -n $<span class="string">"Stopping <span class="variable">$prog</span>: "</span></div><div class="line">    killproc -p <span class="variable">$&#123;pidfile&#125;</span> <span class="variable">$&#123;prog&#125;</span></div><div class="line">    RETVAL=$?</div><div class="line">    <span class="built_in">echo</span></div><div class="line">    [ <span class="variable">$RETVAL</span> = 0 ] &amp;&amp; rm <span class="_">-f</span> <span class="variable">$&#123;lockfile&#125;</span> <span class="variable">$&#123;pidfile&#125;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">reload</span></span>() &#123;</div><div class="line">    <span class="built_in">echo</span> -n $<span class="string">"Reloading <span class="variable">$prog</span>: "</span></div><div class="line">    killproc -p <span class="variable">$&#123;pidfile&#125;</span> <span class="variable">$&#123;prog&#125;</span> -HUP</div><div class="line">    RETVAL=$?</div><div class="line">    <span class="built_in">echo</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">upgrade</span></span>() &#123;</div><div class="line">    oldbinpidfile=<span class="variable">$&#123;pidfile&#125;</span>.oldbin</div><div class="line"></div><div class="line">    configtest -q || <span class="built_in">return</span></div><div class="line">    <span class="built_in">echo</span> -n $<span class="string">"Starting new master <span class="variable">$prog</span>: "</span></div><div class="line">    killproc -p <span class="variable">$&#123;pidfile&#125;</span> <span class="variable">$&#123;prog&#125;</span> -USR2</div><div class="line">    <span class="built_in">echo</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> `/usr/bin/seq <span class="variable">$UPGRADEWAITLOOPS</span>`; <span class="keyword">do</span></div><div class="line">        /bin/usleep <span class="variable">$SLEEPMSEC</span></div><div class="line">        <span class="keyword">if</span> [ <span class="_">-f</span> <span class="variable">$&#123;oldbinpidfile&#125;</span> <span class="_">-a</span> <span class="_">-f</span> <span class="variable">$&#123;pidfile&#125;</span> ]; <span class="keyword">then</span></div><div class="line">            <span class="built_in">echo</span> -n $<span class="string">"Graceful shutdown of old <span class="variable">$prog</span>: "</span></div><div class="line">            killproc -p <span class="variable">$&#123;oldbinpidfile&#125;</span> <span class="variable">$&#123;prog&#125;</span> -QUIT</div><div class="line">            RETVAL=$?</div><div class="line">            <span class="built_in">echo</span></div><div class="line">            <span class="built_in">return</span></div><div class="line">        <span class="keyword">fi</span></div><div class="line">    <span class="keyword">done</span></div><div class="line"></div><div class="line">    <span class="built_in">echo</span> $<span class="string">"Upgrade failed!"</span></div><div class="line">    RETVAL=1</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">configtest</span></span>() &#123;</div><div class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$#</span>"</span> <span class="_">-ne</span> 0 ] ; <span class="keyword">then</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line">            -q)</div><div class="line">                FLAG=<span class="variable">$1</span></div><div class="line">                ;;</div><div class="line">            *)</div><div class="line">                ;;</div><div class="line">        <span class="keyword">esac</span></div><div class="line">        <span class="built_in">shift</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">    <span class="variable">$&#123;nginx&#125;</span> -t -c <span class="variable">$&#123;conffile&#125;</span> <span class="variable">$FLAG</span></div><div class="line">    RETVAL=$?</div><div class="line">    <span class="built_in">return</span> <span class="variable">$RETVAL</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">rh_status</span></span>() &#123;</div><div class="line">    status -p <span class="variable">$&#123;pidfile&#125;</span> <span class="variable">$&#123;nginx&#125;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># See how we were called.</span></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line">    start)</div><div class="line">        rh_status &gt;/dev/null 2&gt;&amp;1 &amp;&amp; <span class="built_in">exit</span> 0</div><div class="line">        start</div><div class="line">        ;;</div><div class="line">    stop)</div><div class="line">        stop</div><div class="line">        ;;</div><div class="line">    status)</div><div class="line">        rh_status</div><div class="line">        RETVAL=$?</div><div class="line">        ;;</div><div class="line">    restart)</div><div class="line">        configtest -q || <span class="built_in">exit</span> <span class="variable">$RETVAL</span></div><div class="line">        stop</div><div class="line">        start</div><div class="line">        ;;</div><div class="line">    upgrade)</div><div class="line">        rh_status &gt;/dev/null 2&gt;&amp;1 || <span class="built_in">exit</span> 0</div><div class="line">        upgrade</div><div class="line">        ;;</div><div class="line">    condrestart|try-restart)</div><div class="line">        <span class="keyword">if</span> rh_status &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></div><div class="line">            stop</div><div class="line">            start</div><div class="line">        <span class="keyword">fi</span></div><div class="line">        ;;</div><div class="line">    force-reload|reload)</div><div class="line">        reload</div><div class="line">        ;;</div><div class="line">    configtest)</div><div class="line">        configtest</div><div class="line">        ;;</div><div class="line">    *)</div><div class="line">        <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$prog</span> &#123;start|stop|restart|condrestart|try-restart|force-reload|upgrade|reload|status|help|configtest&#125;"</span></div><div class="line">        RETVAL=2</div><div class="line"><span class="keyword">esac</span></div><div class="line"></div><div class="line"><span class="built_in">exit</span> <span class="variable">$RETVAL</span></div></pre></td></tr></table></figure>
<h4 id="3-4-3-4-fastcgi-params-参数"><a href="#3-4-3-4-fastcgi-params-参数" class="headerlink" title="3.4.3.4 fastcgi_params 参数"></a>3.4.3.4 fastcgi_params 参数</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">fastcgi_param  QUERY_STRING       <span class="variable">$query_string</span>;</div><div class="line">fastcgi_param  REQUEST_METHOD     <span class="variable">$request_method</span>;</div><div class="line">fastcgi_param  CONTENT_TYPE       <span class="variable">$content_type</span>;</div><div class="line">fastcgi_param  CONTENT_LENGTH     <span class="variable">$content_length</span>;</div><div class="line"></div><div class="line">fastcgi_param  SCRIPT_NAME        <span class="variable">$fastcgi_script_name</span>;</div><div class="line">fastcgi_param  REQUEST_URI        <span class="variable">$request_uri</span>;</div><div class="line">fastcgi_param  DOCUMENT_URI       <span class="variable">$document_uri</span>;</div><div class="line">fastcgi_param  DOCUMENT_ROOT      <span class="variable">$document_root</span>;</div><div class="line">fastcgi_param  SERVER_PROTOCOL    <span class="variable">$server_protocol</span>;</div><div class="line">fastcgi_param  HTTPS              <span class="variable">$https</span> if_not_empty;</div><div class="line"></div><div class="line">fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;</div><div class="line">fastcgi_param  SERVER_SOFTWARE    nginx/<span class="variable">$nginx_version</span>;</div><div class="line"></div><div class="line">fastcgi_param  REMOTE_ADDR        <span class="variable">$remote_addr</span>;</div><div class="line">fastcgi_param  REMOTE_PORT        <span class="variable">$remote_port</span>;</div><div class="line">fastcgi_param  SERVER_ADDR        <span class="variable">$server_addr</span>;</div><div class="line">fastcgi_param  SERVER_PORT        <span class="variable">$server_port</span>;</div><div class="line">fastcgi_param  SERVER_NAME        <span class="variable">$server_name</span>;</div><div class="line"></div><div class="line"><span class="comment"># PHP only, required if PHP was built with --enable-force-cgi-redirect</span></div><div class="line">fastcgi_param  REDIRECT_STATUS    200;</div></pre></td></tr></table></figure>
<h3 id="3-4-4-在-SPECS-目录下创建-nginx-spec"><a href="#3-4-4-在-SPECS-目录下创建-nginx-spec" class="headerlink" title="3.4.4 在 SPECS 目录下创建 nginx.spec"></a>3.4.4 在 SPECS 目录下创建 nginx.spec</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> rpmbuild/SPECS/</div><div class="line">$ vim nginx.spec     <span class="comment">#此时，里面就是一个模板，直接填就可以了</span></div><div class="line"> </div><div class="line"><span class="comment"># 1.The introduction section</span></div><div class="line"> </div><div class="line">Name: nginx           <span class="comment"># 软件包名称</span></div><div class="line">Version: 1.8.1        <span class="comment"># 版本号，（不能使用-）</span></div><div class="line">Release: 1%&#123;?dist&#125;    <span class="comment"># release号，对应下面的changelog，如 nginx-1.8.1-1.el6.x86_64.rpm</span></div><div class="line">Summary: nginx-1.8.1.tar.gz to nginx-1.8.1.rpm   <span class="comment"># 简要描述信息，最好不要超过50个字符，如要详述，使用下面的%description</span></div><div class="line">Group: Applications/Archiving      <span class="comment"># 要全用这里面的一个组：less /usr/share/doc/rpm-version/GROUPS</span></div><div class="line">License: GPLv2                     <span class="comment"># 一定带上（最好是对方源码包的License）BSD，GPL，GPLv2</span></div><div class="line">URL: http://nginx.org</div><div class="line">Packager: go2.cn</div><div class="line">Vendor: go2.cn</div><div class="line">Source0: %&#123;name&#125;-%&#123;version&#125;.tar.gz     <span class="comment"># source主要是引用一下自己定义好的脚本，配置文件之类的内容。</span></div><div class="line">Source1: nginx                         <span class="comment"># nginx在主配置文件里面做了很多优化，包括cpu抢占，各种缓存策略，tcp，进程数等。</span></div><div class="line">Source2: nginx.conf                    <span class="comment"># 每增加一个 Source ，都需要在 %install 段和 %files 段做相应配置，如果是启动脚本的话，最好在脚本段配置一下</span></div><div class="line">Source3: fastcgi_params</div><div class="line">BuildRoot: %_topdir/BUILDROOT</div><div class="line"> </div><div class="line">BuildRequires: gcc</div><div class="line">Requires: openssl,openssl-devel,pcre-devel,pcre  <span class="comment"># 定义nginx依赖的包，需要yum安装</span></div><div class="line"> </div><div class="line">%description              <span class="comment"># 软件包详述</span></div><div class="line">Custom a rpm by yourself!Build nginx-1.8.1.tar.gz to nginx-1.8.1.rpm</div><div class="line"> </div><div class="line"><span class="comment"># 2.The Prep section 准备阶段,主要就是把源码包解压到build目录下，设置一下环境变量，并cd进去</span></div><div class="line"> </div><div class="line">%prep</div><div class="line">%setup -q    <span class="comment"># 这个宏的作用静默模式解压并cd</span></div><div class="line"> </div><div class="line"><span class="comment"># 3.The Build Section 编译制作阶段，这一节主要用于编译源码</span></div><div class="line"> </div><div class="line">%build</div><div class="line"> </div><div class="line">%configure      <span class="comment">#在 RMP 创建时候, 由于 nginx 不按照常规定义, 不可以定义 %&#123;_prefix&#125; 之类参数, 也不可以使用 %configure 这个参数进行 rpm 编译  </span></div><div class="line">                <span class="comment">#一旦定义该参数, 会导致编译自动增加下面参数, 导致报错</span></div><div class="line">                <span class="comment"># + ./configure --build=x86_64-redhat-linux-gnu --host=x86_64-redhat-linux-gnu --target=x86_64-redhat-linux-gnu --program-prefix=</span></div><div class="line">                <span class="comment">#因此，这里需要 ./configure，且需把%configure删掉</span></div><div class="line">                <span class="comment">#而且这里需要安装 pcre-devel包，如果没有的话，会提示关于pcre的错误，直接安装此包就可以了</span></div><div class="line"></div><div class="line">./configure \</div><div class="line">--prefix=/gotwo_data/Application/nginx \</div><div class="line">--sbin-path=/gotwo_data/Application/nginx/sbin/nginx \</div><div class="line">--conf-path=/gotwo_data/Application/nginx/conf/nginx.conf \</div><div class="line">--error-log-path=/gotwo_data/logs/nginx/error.log \</div><div class="line">--http-log-path=/gotwo_data/logs/nginx/access.log \</div><div class="line">--pid-path=/gotwo_data/logs/nginx/nginx.pid \</div><div class="line">--lock-path=/gotwo_data/logs/nginx/nginx.lock \</div><div class="line">--http-client-body-temp-path=/gotwo_data/Application/nginx/client_temp \</div><div class="line">--http-proxy-temp-path=/gotwo_data/Application/nginx/proxy_temp \</div><div class="line">--http-fastcgi-temp-path=/gotwo_data/Application/nginx/fastcgi_temp \</div><div class="line">--http-uwsgi-temp-path=/gotwo_data/Application/nginx/uwsgi_temp \</div><div class="line">--http-scgi-temp-path=/gotwo_data/Application/nginx/scgi_temp \</div><div class="line">--user=nginx \</div><div class="line">--group=nginx \</div><div class="line">--with-http_ssl_module \</div><div class="line">--with-http_realip_module \</div><div class="line">--with-http_addition_module \</div><div class="line">--with-http_sub_module \</div><div class="line">--with-http_dav_module \</div><div class="line">--with-http_flv_module \</div><div class="line">--with-http_mp4_module \</div><div class="line">--with-http_gunzip_module \</div><div class="line">--with-http_gzip_static_module \</div><div class="line">--with-http_random_index_module \</div><div class="line">--with-http_secure_link_module \</div><div class="line">--with-http_stub_status_module \</div><div class="line">--with-http_auth_request_module \</div><div class="line">--with-mail \</div><div class="line">--with-mail_ssl_module \</div><div class="line">--with-file-aio \</div><div class="line">--with-ipv6 \</div><div class="line">--with-http_spdy_module \</div><div class="line">--with-cc-opt=<span class="string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic'</span></div><div class="line"></div><div class="line">make %&#123;?_smp_mflags&#125;     <span class="comment"># make后面的意思是：如果就多处理器的话make时并行编译</span></div><div class="line"> </div><div class="line"><span class="comment"># 4.Install section  这一节主要用于完成实际安装软件必须执行的命令，可包含4种类型脚本</span></div><div class="line"> </div><div class="line">%install</div><div class="line">rm -rf %&#123;buildroot&#125;</div><div class="line">make install DESTDIR=%&#123;buildroot&#125;</div><div class="line">%&#123;__install&#125; -p -D -m 0755 %&#123;SOURCE1&#125; %&#123;buildroot&#125;/etc/rc.d/init.d/nginx</div><div class="line">%&#123;__install&#125; -p -D %&#123;SOURCE2&#125; %&#123;buildroot&#125;/gotwo_data/Application/nginx/conf/nginx.conf</div><div class="line">%&#123;__install&#125; -p -D %&#123;SOURCE3&#125; %&#123;buildroot&#125;/gotwo_data/Application/nginx/conf/fastcgi_params</div><div class="line"> </div><div class="line">%pre</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == 1 ];<span class="keyword">then</span>                                                           <span class="comment"># $1有3个值，代表动作，安装类型，处理类型</span></div><div class="line">        /usr/sbin/useradd -r nginx <span class="_">-s</span> /sbin/nologin 2&gt; /dev/null</div><div class="line"></div><div class="line">        mkdir -p /gotwo_data/logs/nginx                                       <span class="comment"># 1：表示安装</span></div><div class="line"><span class="keyword">fi</span>                                                                            <span class="comment"># 2：表示升级      </span></div><div class="line">                                                                              <span class="comment"># 0：表示卸载</span></div><div class="line">%post</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == 1 ];<span class="keyword">then</span></div><div class="line">        /sbin/chkconfig --add %&#123;name&#125;</div><div class="line">        /sbin/chkconfig %&#123;name&#125; on</div><div class="line">        <span class="built_in">echo</span> <span class="string">'# Add  #下面主要是内核参数的优化，包括tcp的快速释放和重利用等。   </span></div><div class="line">net.ipv4.tcp_max_syn_backlog = 65536</div><div class="line">net.core.netdev_max_backlog =  32768</div><div class="line">net.core.somaxconn = 32768</div><div class="line"> </div><div class="line">net.core.wmem_default = 8388608</div><div class="line">net.core.rmem_default = 8388608</div><div class="line">net.core.rmem_max = 16777216</div><div class="line">net.core.wmem_max = 16777216</div><div class="line"> </div><div class="line">net.ipv4.tcp_timestamps = 0</div><div class="line">net.ipv4.tcp_synack_retries = 2</div><div class="line">net.ipv4.tcp_syn_retries = 2</div><div class="line"> </div><div class="line">net.ipv4.tcp_tw_recycle = 1</div><div class="line">net.ipv4.tcp_tw_reuse = 1</div><div class="line"> </div><div class="line">net.ipv4.tcp_mem = 94500000 915000000927000000</div><div class="line">net.ipv4.tcp_max_orphans = 3276800</div><div class="line"> </div><div class="line">#net.ipv4.tcp_fin_timeout = 30</div><div class="line">#net.ipv4.tcp_keepalive_time = 120</div><div class="line">net.ipv4.ip_local_port_range = 1024  65535' &gt;&gt; /etc/sysctl.conf</div><div class="line">sysctl -p 2&gt;&amp;1 /dev/null</div><div class="line"><span class="keyword">fi</span></div><div class="line"> </div><div class="line">%preun</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == 0 ];<span class="keyword">then</span></div><div class="line">        /usr/sbin/userdel -r nginx 2&gt; /dev/null</div><div class="line">        /etc/init.d/nginx stop &gt; /dev/null 2&gt;&amp;1</div><div class="line"><span class="keyword">fi</span></div><div class="line">%postun</div><div class="line"> </div><div class="line"><span class="comment"># 5.clean section 清理段,clean的主要作用就是删除BUILD</span></div><div class="line"> </div><div class="line">%clean</div><div class="line">rm -rf %&#123;buildroot&#125;</div><div class="line"> </div><div class="line"><span class="comment"># 6.file section 文件列表段，这个阶段是把前面已经编译好的内容要打包了,其中exclude是指要排除什么不打包进来。</span></div><div class="line"> </div><div class="line">%files              </div><div class="line">%defattr(-,root,root,0755)</div><div class="line">/usr/<span class="built_in">local</span>/nginx/</div><div class="line">%attr(0755,root,root) /etc/rc.d/init.d/nginx</div><div class="line">%config(noreplace) /gotwo_data/Application/nginx/conf/nginx.conf</div><div class="line">%config(noreplace) /gotwo_data/Application/nginx/conf/fastcgi_params</div><div class="line"> </div><div class="line"><span class="comment"># 7.chagelog section  日志改变段， 这一段主要描述软件的开发记录</span></div><div class="line"> </div><div class="line">%changelog</div><div class="line">*  Thu Nov 16  2016 go2.cn &lt;yunwei@stargoto.com&gt; - 1.8.1-1</div><div class="line">- Initial version</div></pre></td></tr></table></figure>
<h3 id="3-4-5-制作rpm包"><a href="#3-4-5-制作rpm包" class="headerlink" title="3.4.5 制作rpm包"></a>3.4.5 制作rpm包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">rpmbuild -bp nginx.spec 制作到%prep段</div><div class="line">rpmbuild -bc nginx.spec 制作到%build段</div><div class="line">rpmbuild -bi nginx.spec 执行 spec 文件的 &quot;%install&quot; 阶段 (在执行了 %prep 和 %build 阶段之后)。这通常等价于执行了一次 &quot;make install&quot;</div><div class="line">rpmbuild -bb nginx.spec 制作二进制包</div><div class="line">rpmbuild -ba nginx.spec 表示既制作二进制包又制作src格式包</div></pre></td></tr></table></figure>
<h2 id="3-5-rpm包的签名"><a href="#3-5-rpm包的签名" class="headerlink" title="3.5 rpm包的签名"></a>3.5 rpm包的签名</h2><h3 id="3-5-1-查询软件包信息"><a href="#3-5-1-查询软件包信息" class="headerlink" title="3.5.1 查询软件包信息"></a>3.5.1 查询软件包信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># rpm -qi nginx</span></div><div class="line">Name        : nginx                        Relocations: (not relocatable)</div><div class="line">Version     : 1.7.7                             Vendor: nmshuishui</div><div class="line">Release     : 3.el6                         Build Date: Wed 26 Nov 2014 06:39:00 PM CST</div><div class="line">Install Date: Wed 26 Nov 2014 06:42:19 PM CST      Build Host: localhost</div><div class="line">Group       : Applications/Archiving        Source RPM: nginx-1.7.7-3.el6.src.rpm</div><div class="line">Size        : 793593                           License: GPLv2</div><div class="line">Signature   : (none)    <span class="comment"># rpm包未签名状态</span></div><div class="line">Packager    : nmshuishui &lt;353025240@qq.com&gt;</div><div class="line">URL         : http://nmshuishui.blog.51cto.com/</div><div class="line">Summary     : nginx-1.7.7.tar.gz to nginx-1.7.7.rpm</div><div class="line">Description :</div><div class="line">Custom a rpm by yourself!Build nginx-1.7.7.tar.gz to nginx-1.7.7.rpm</div></pre></td></tr></table></figure>
<h3 id="3-5-2-使用gpg方式生成签名密钥"><a href="#3-5-2-使用gpg方式生成签名密钥" class="headerlink" title="3.5.2 使用gpg方式生成签名密钥"></a>3.5.2 使用gpg方式生成签名密钥</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># gpg --gen-key</span></div><div class="line">Your selection?1&lt;Enter&gt;  <span class="comment">#默认即可</span></div><div class="line">What keysize <span class="keyword">do</span> you want? (2048) 1024&lt;Enter&gt;  <span class="comment">#选择密钥长度</span></div><div class="line">Key is valid <span class="keyword">for</span>? (0) 1y&lt;Enter&gt;  <span class="comment">#有效期</span></div><div class="line">Is this correct? (y/N) y&lt;Enter&gt;  <span class="comment">#确认</span></div><div class="line">Real name: nmshuishui&lt;Enter&gt;  <span class="comment">#密钥名称</span></div><div class="line">Email address: 353025240@qq.com&lt;Enter&gt;  <span class="comment">#邮件</span></div><div class="line">Comment: GPG-RPM-KEY&lt;Enter&gt;  <span class="comment">#备注</span></div><div class="line">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O&lt;ENTER&gt; <span class="comment">#okay确认</span></div><div class="line">Enter passphrase  OK &lt;Enter&gt;  <span class="comment">#按Enter输入密码                    </span></div><div class="line">&lt;Take this one anyway&gt; &lt;Enter&gt; <span class="comment">#确认使用此密码</span></div></pre></td></tr></table></figure>
<p>　　在生成密钥的时候，会报这么一个信息：can’t connect to `/root/.gnupg/S.gpg-agent’: No such file or directory，可以不用理会它。<br>接下来就是一些随机数的说明了：</p>
<p>　　We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy.</p>
<p>　　就狂敲键盘和移动鼠标吧，也可以链接一个伪随机数（不过不安全），接下来的活儿就是等了</p>
<p>　　生成密钥后会是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">gpg: checking the trustdb</div><div class="line">gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model</div><div class="line">gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u</div><div class="line">pub   2048R/DF63EDFB 2014-11-26</div><div class="line">      Key fingerprint = 338D 476F 29C9 E2D6 6604  1D96 6F73 1E81 DF63 EDFB</div><div class="line">uid                  nmshuishui (gen-key) &lt;353025240@qq.com&gt;</div><div class="line">sub   2048R/263FB359 2014-11-26</div></pre></td></tr></table></figure>
<h3 id="3-5-3-查看生成的密钥"><a href="#3-5-3-查看生成的密钥" class="headerlink" title="3.5.3 查看生成的密钥"></a>3.5.3 查看生成的密钥</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># gpg --list-keys</span></div><div class="line">/root/.gnupg/pubring.gpg</div><div class="line">------------------------</div><div class="line">pub   2048R/DF63EDFB 2014-11-26</div><div class="line">uid                  nmshuishui (gen-key) &lt;353025240@qq.com&gt;</div><div class="line">sub   2048R/263FB359 2014-11-26</div></pre></td></tr></table></figure>
<h3 id="3-5-4-导出公钥以供验证"><a href="#3-5-4-导出公钥以供验证" class="headerlink" title="3.5.4 导出公钥以供验证"></a>3.5.4 导出公钥以供验证</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># gpg --export -a "nmshuishui" &gt; RPM-GPG-KEY-nmshuishui</span></div></pre></td></tr></table></figure>
<h3 id="3-5-5-在-rpmmacros宏中定义加密密钥"><a href="#3-5-5-在-rpmmacros宏中定义加密密钥" class="headerlink" title="3.5.5 在~/.rpmmacros宏中定义加密密钥"></a>3.5.5 在~/.rpmmacros宏中定义加密密钥</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># vim ~/.rpmmacros</span></div><div class="line">%_gpg_name nmshuishui</div></pre></td></tr></table></figure>
<h3 id="3-5-6-为rpm包签名"><a href="#3-5-6-为rpm包签名" class="headerlink" title="3.5.6 为rpm包签名"></a>3.5.6 为rpm包签名</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># rpm --addsign /home/hero/rpmbuild/RPMS/x86_64/nginx-1.7.7-3.el6.x86_64.rpm </span></div><div class="line">Enter pass phrase: </div><div class="line">Pass phrase is good.</div><div class="line">/home/hero/rpmbuild/RPMS/x86_64/nginx-1.7.7-3.el6.x86_64.rpm:</div></pre></td></tr></table></figure>
<h3 id="3-5-7-将公钥导入rpm包"><a href="#3-5-7-将公钥导入rpm包" class="headerlink" title="3.5.7 将公钥导入rpm包"></a>3.5.7 将公钥导入rpm包</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># rpm --import RPM-GPG-KEY-nmshuishui</span></div></pre></td></tr></table></figure>
<h3 id="3-5-8-验证"><a href="#3-5-8-验证" class="headerlink" title="3.5.8 验证"></a>3.5.8 验证</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># rpm --checksig /home/hero/rpmbuild/RPMS/x86_64/nginx-1.7.7-3.el6.x86_64.rpm</span></div><div class="line">/home/hero/rpmbuild/RPMS/x86_64/nginx-1.7.7-3.el6.x86_64.rpm: rsa sha1 (md5) pgp md5 OK</div></pre></td></tr></table></figure>
<h3 id="3-5-9-重新安装nginx，验证安装包的签名信息"><a href="#3-5-9-重新安装nginx，验证安装包的签名信息" class="headerlink" title="3.5.9 重新安装nginx，验证安装包的签名信息"></a>3.5.9 重新安装nginx，验证安装包的签名信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]<span class="comment"># rpm -ivh /home/hero/rpmbuild/RPMS/x86_64/nginx-1.7.7-3.el6.x86_64.rpm </span></div><div class="line">Preparing...                <span class="comment">########################################### [100%]</span></div><div class="line">   1:nginx                  <span class="comment">########################################### [100%]</span></div><div class="line">[root@localhost ~]<span class="comment"># </span></div><div class="line">[root@localhost ~]<span class="comment"># rpm -qi nginx</span></div><div class="line">Name        : nginx                        Relocations: (not relocatable)</div><div class="line">Version     : 1.7.7                             Vendor: nmshuishui</div><div class="line">Release     : 3.el6                         Build Date: Wed 26 Nov 2014 06:39:00 PM CST</div><div class="line">Install Date: Thu 27 Nov 2014 10:58:44 AM CST      Build Host: localhost</div><div class="line">Group       : Applications/Archiving        Source RPM: nginx-1.7.7-3.el6.src.rpm</div><div class="line">Size        : 793593                           License: GPLv2</div><div class="line">Signature   : RSA/SHA1, Thu 27 Nov 2014 10:40:02 AM CST, Key ID 6f731e81df63edfb   <span class="comment"># 与 1 比起来，多了签名信息</span></div><div class="line">Packager    : nmshuishui &lt;353025240@qq.com&gt;</div><div class="line">URL         : http://nmshuishui.blog.51cto.com/</div><div class="line">Summary     : nginx-1.7.7.tar.gz to nginx-1.7.7.rpm</div><div class="line">Description :</div><div class="line">Custom a rpm by yourself!Build nginx-1.7.7.tar.gz to nginx-1.7.7.rpm</div></pre></td></tr></table></figure>
<p>到这里，一个完整的 rpm 包就制作完成了！</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a rel="external nofollow" href="/2017/06/12/service/nginx安装/">nginx安装</a></p>
        <p><span>文章作者:</span><a rel="external nofollow" href="/" title="访问 Linux运维装逼指南 的个人博客">Linux运维装逼指南</a></p>
        <p><span>发布时间:</span>2017年06月12日 - 22时21分</p>
        <p><span>最后更新:</span>2017年06月12日 - 22时33分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/06/12/service/nginx安装/" title="nginx安装">http://www.unix-like.com/2017/06/12/service/nginx安装/</a>
            <span class="copy-path" data-clipboard-text="原文: http://www.unix-like.com/2017/06/12/service/nginx安装/　　作者: Linux运维装逼指南" title=""></span>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
  
    <a rel="external nofollow" href="/2017/06/09/database/用innobackup备份恢复mysql/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">用innobackup备份恢复mysql</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一-rpm包安装"><span class="toc-number">1.</span> <span class="toc-text">一. rpm包安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-配置nginx-官方yum源用以安装最新稳定版"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 配置nginx 官方yum源用以安装最新稳定版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-安装nginx"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 安装nginx</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二-编译安装"><span class="toc-number">2.</span> <span class="toc-text">二. 编译安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-必要软件准备"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 必要软件准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-安装pcre"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 安装pcre</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-安装openssl"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 安装openssl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-安装nginx"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 安装nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-配置编译参数"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 配置编译参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-编译nginx"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 编译nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-安装nginx"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 安装nginx</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-启动、关闭、重置nginx"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 启动、关闭、重置nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-启动：直接执行以下命令-nginx就启动了-不需要改任何配置文件-nginx配置多域名虚拟主机请参考后续文章"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 启动：直接执行以下命令,nginx就启动了,不需要改任何配置文件,nginx配置多域名虚拟主机请参考后续文章.</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-关闭："><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 关闭：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-重置：当你有修改配置文件的时候，只需要reload以下即可"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 重置：当你有修改配置文件的时候，只需要reload以下即可</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三-从源码打包成rpm包安装"><span class="toc-number">3.</span> <span class="toc-text">三. 从源码打包成rpm包安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-RPM包的分类"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 RPM包的分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-修改宏及自定义车间位置"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 修改宏及自定义车间位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-rpm包制作原理图"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 rpm包制作原理图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-制作rpm包"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 制作rpm包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-安装rpm-build"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 安装rpm-build</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-增加普通用户并修改工作车间目录"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 增加普通用户并修改工作车间目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-收集源码文件"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 收集源码文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3-1-文件列表"><span class="toc-number">3.4.3.1.</span> <span class="toc-text">3.4.3.1 文件列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3-2-nginx-1-8-1-tar-gz-源码包"><span class="toc-number">3.4.3.2.</span> <span class="toc-text">3.4.3.2 nginx-1.8.1.tar.gz 源码包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3-3-nginx启动脚本文件"><span class="toc-number">3.4.3.3.</span> <span class="toc-text">3.4.3.3 nginx启动脚本文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3-4-fastcgi-params-参数"><span class="toc-number">3.4.3.4.</span> <span class="toc-text">3.4.3.4 fastcgi_params 参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-在-SPECS-目录下创建-nginx-spec"><span class="toc-number">3.4.4.</span> <span class="toc-text">3.4.4 在 SPECS 目录下创建 nginx.spec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-5-制作rpm包"><span class="toc-number">3.4.5.</span> <span class="toc-text">3.4.5 制作rpm包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-rpm包的签名"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 rpm包的签名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-查询软件包信息"><span class="toc-number">3.5.1.</span> <span class="toc-text">3.5.1 查询软件包信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-使用gpg方式生成签名密钥"><span class="toc-number">3.5.2.</span> <span class="toc-text">3.5.2 使用gpg方式生成签名密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-3-查看生成的密钥"><span class="toc-number">3.5.3.</span> <span class="toc-text">3.5.3 查看生成的密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-4-导出公钥以供验证"><span class="toc-number">3.5.4.</span> <span class="toc-text">3.5.4 导出公钥以供验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-5-在-rpmmacros宏中定义加密密钥"><span class="toc-number">3.5.5.</span> <span class="toc-text">3.5.5 在~/.rpmmacros宏中定义加密密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-6-为rpm包签名"><span class="toc-number">3.5.6.</span> <span class="toc-text">3.5.6 为rpm包签名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-7-将公钥导入rpm包"><span class="toc-number">3.5.7.</span> <span class="toc-text">3.5.7 将公钥导入rpm包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-8-验证"><span class="toc-number">3.5.8.</span> <span class="toc-text">3.5.8 验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-9-重新安装nginx，验证安装包的签名信息"><span class="toc-number">3.5.9.</span> <span class="toc-text">3.5.9 重新安装nginx，验证安装包的签名信息</span></a></li></ol></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="/js/require-2.1.6-jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>








    



    <div class="scroll" id="post-nav-button">
        
            <a rel="external nofollow" href="/" title="回到主页"><i class="fa fa-home"></i></a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a rel="external nofollow" href="/2017/06/09/database/用innobackup备份恢复mysql/" title="下一篇: 用innobackup备份恢复mysql">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/06/12/service/nginx安装/">nginx安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/09/database/用innobackup备份恢复mysql/">用innobackup备份恢复mysql</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/database/修复mysql主从不一致/">修复mysql主从不一致</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/service/linux下添加redis扩展/">linux下添加redis扩展</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/service/tomcat软件部署及项目部署脚本/">Tomcat环境搭建及配置规范</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/database/mongodb线上线下同步备份脚步/">mongodb线上线下同步备份脚步</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/database/mysql线上线下同步备份脚步/">mysql线上线下同步备份脚步</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/07/service/Linux服务器iptables配置/">Linux服务器iptables配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/service/在Ubuntu15.04上配置OpenVPN服务器和客户端/">Ubuntu 15.04 上配置 OpenVPN 服务器和客户端</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/service/Ubuntu下OpenVPN客户端配置/">Ubuntu下OpenVPN客户端配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/04/service/KVM部署及虚拟机安装/">kvm部署及虚拟机安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/02/system/使用命令行生成高强度密码/">使用命令行生成高强度密码</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/31/system/LINUX下解决netstat查看TIME-WAIT状态过多问题/">LINUX下解决netstat查看TIME_WAIT状态过多问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/31/service/logrotate切割日志nginx和php配置/">logrotate切割日志nginx和php配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/31/service/nginx常见问题/">nginx常见问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/30/system/恢复linux被误删文件/">恢复linux被误删文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/30/service/修改PHP上传文件大小限制/">修改PHP上传文件大小限制</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/29/service/ Windows与Linux共享文件夹互相访问 /">Windows与Linux共享文件夹互相访问</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/28/life/系统运维工程师装逼完全指南/">系统运维工程师装逼完全指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/28/life/运维人装逼指南大全/">运维人装逼指南大全</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/28/service/tc命令Linux基于IP进行流量限速/">tc命令——Linux基于IP进行流量限速</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/27/system/Linux上ssd优化/">Linux上ssd优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/26/service/rsync安装配置实例/">rsync安装配置实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/system/pdflush进程详解与优化/">pdflush进程详解与优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/database/MongoDB归档及压缩工具/">MongoDB归档及压缩工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/system/Linux下清空或删除大文件内容的5种方法/">Linux下清空或删除大文件内容的5种方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/database/redis模糊删除key/">redis模糊删除key</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/system/Linux查看文件编码格式及文件编码转换/">Linux查看文件编码格式及文件编码转换</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/system/Bash历史中执行过的每一项命令设置时间和日期/">Bash历史中执行过的每一项命令设置时间和日期.md</a></li></ul>
    <script src="/js/require-2.1.6-jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        // $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2017 Linux运维装逼指南
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a><a href="https://github.com/maochunguang" target="_blank">Blog</a> by tommy
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >极客到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="/css/require-2.1.6-jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 1;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>






<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>


<script async src="/js/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>