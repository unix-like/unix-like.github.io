<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="L6Lm9d5Crl"/>
  
  
  

  
  <title>tc命令——Linux基于IP进行流量限速 | Linux运维装逼指南</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一、TC原理　　Linux操作系统中的流量控制器TC（Traffic Control）用于Linux内核的流量控制，主要是通过在输出端口处建立一个队列来实现流量控制。">
<meta name="keywords" content="tc">
<meta property="og:type" content="article">
<meta property="og:title" content="tc命令——Linux基于IP进行流量限速">
<meta property="og:url" content="http://www.unix-like.com/2017/05/28/service/tc命令Linux基于IP进行流量限速/index.html">
<meta property="og:site_name" content="Linux运维装逼指南">
<meta property="og:description" content="一、TC原理　　Linux操作系统中的流量控制器TC（Traffic Control）用于Linux内核的流量控制，主要是通过在输出端口处建立一个队列来实现流量控制。">
<meta property="og:updated_time" content="2017-05-28T05:28:24.284Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="tc命令——Linux基于IP进行流量限速">
<meta name="twitter:description" content="一、TC原理　　Linux操作系统中的流量控制器TC（Traffic Control）用于Linux内核的流量控制，主要是通过在输出端口处建立一个队列来实现流量控制。">
  
    <link rel="alternative" href="/atom.xml" title="Linux运维装逼指南" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  <link rel="stylesheet" href="/css/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: true
      }
  </script>
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <script src="/js/require-2.1.6-jquery-1.9.1.min.js"></script>
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/avatar.png" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">Linux运维装逼指南</a></h1>
        </hgroup>

        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder=" Search...">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>

                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a rel="external nofollow" href="/archives/">所有文章</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/database">数据库</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/python">编程</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/system">操作系统</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/security">安全</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/service">应用服务</a></li>
                        
                            <li><a rel="external nofollow" href="/about/">关于我</a></li>
                        
                            <li><a rel="external nofollow" href="/categories/life">生活随笔</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" rel="external nofollow" target="_blank" href="https://github.com/unix-like" title="github">github</a>
                            
                                <a class="fl rss" rel="external nofollow" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>

                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/bash/" style="font-size: 15px;">bash</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/kvm/" style="font-size: 10px;">kvm</a> <a href="/tags/logrotate/" style="font-size: 10px;">logrotate</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/openvpn/" style="font-size: 15px;">openvpn</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/samba/" style="font-size: 10px;">samba</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/tc/" style="font-size: 10px;">tc</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/字符集/" style="font-size: 10px;">字符集</a> <a href="/tags/数据恢复/" style="font-size: 10px;">数据恢复</a> <a href="/tags/职业/" style="font-size: 15px;">职业</a> <a href="/tags/调优/" style="font-size: 20px;">调优</a>
                    </div>
                </section>
                

                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">一个做运维的人!</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Linux运维装逼指南</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/avatar.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Linux运维装逼指南</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/categories/database">数据库</a></li>
                
                    <li><a href="/categories/python">编程</a></li>
                
                    <li><a href="/categories/system">操作系统</a></li>
                
                    <li><a href="/categories/security">安全</a></li>
                
                    <li><a href="/categories/service">应用服务</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                    <li><a href="/categories/life">生活随笔</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/unix-like" title="github">github</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-service/tc命令Linux基于IP进行流量限速" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a rel="external nofollow" href="/2017/05/28/service/tc命令Linux基于IP进行流量限速/" class="article-date">
      <time datetime="2017-05-28T05:18:20.000Z" itemprop="datePublished">2017-05-28</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      tc命令——Linux基于IP进行流量限速
    </h1>
  


      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/service/">service</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tc/">tc</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="一、TC原理"><a href="#一、TC原理" class="headerlink" title="一、TC原理"></a>一、TC原理</h1><p>　　Linux操作系统中的流量控制器TC（Traffic Control）用于Linux内核的流量控制，主要是通过在输出端口处建立一个队列来实现流量控制。</p>
<a id="more"></a>
<p>　　接收包从输入接口进来后，经过流量限制丢弃不符合规定的数据包，由输入多路分配器进行判断选择：</p>
<ul>
<li>如果接收包的目的主机是本主机，那么将该包送给上层处理，否则需要进行转发，将接收包交到转发块（Forwarding Block）处理。</li>
<li>转发块同时也接收本主机上层(TCP、UDP等)产生的包，通过查看路由表，决定所处理包的下一跳。</li>
<li>然后，对包进行排列以便将它们送到输出接口。</li>
</ul>
<p>　　一般只能限制网卡发送的数据包，不能限制网卡接收的数据包，所以可以通过改变发送次序靠控制传输速率。Linux流量控制主要是在输出接口排列时进行处理和实现的。</p>
<h1 id="二、TC规则"><a href="#二、TC规则" class="headerlink" title="二、TC规则"></a>二、TC规则</h1><h2 id="2-1、流量控制方式"><a href="#2-1、流量控制方式" class="headerlink" title="2.1、流量控制方式"></a>2.1、流量控制方式</h2><p>　　流量控制包括以下几种方式：</p>
<ul>
<li>SHAPING(限制) </li>
</ul>
<p>　　当流量被限制，它的传输速率就被控制在某个值以下。限制值可以大大小于有效带宽，这样可以平滑突发数据流量，使网络更为稳定。shaping（限制）只适用于向外的流量。</p>
<ul>
<li>SCHEDULING(调度)      </li>
</ul>
<p>　　通过调度数据包的传输，可以在带宽范围内，按照优先级分配带宽。SCHEDULING(调度)也只适于向外的流量。</p>
<ul>
<li>POLICING(策略)      </li>
</ul>
<p>　　SHAPING用于处理向外的流量，而POLICIING(策略)用于处理接收到的数据。</p>
<ul>
<li>DROPPING(丢弃)      </li>
</ul>
<p>　　如果流量超过某个设定的带宽，就丢弃数据包，不管是向内还是向外。</p>
<h2 id="2-2、流量控制处理对象"><a href="#2-2、流量控制处理对象" class="headerlink" title="2.2、流量控制处理对象"></a>2.2、流量控制处理对象</h2><p>　　流量的处理由三种对象控制，它们是：</p>
<ul>
<li>qdisc(排队规则)</li>
<li>class(类别)</li>
<li>filter(过滤器)</li>
</ul>
<h3 id="QDISC-排队规则"><a href="#QDISC-排队规则" class="headerlink" title="QDISC(排队规则)"></a>QDISC(排队规则)</h3><p>　　QDisc(排队规则)是queueing discipline的简写，它是理解流量控制(traffic control)的基础。<strong>无论何时，内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的qdisc(排队规则)把数据包加入队列。</strong> 然后，内核会尽可能多地从qdisc里面取出数据包，把它们交给网络适配器驱动模块。最简单的QDisc是pfifo它不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。不过，它会保存网络接口一时无法处理的数据包。</p>
<p>　　QDISC的类别如下：</p>
<h4 id="（1）、CLASSLESS-QDisc-不可分类QDisc"><a href="#（1）、CLASSLESS-QDisc-不可分类QDisc" class="headerlink" title="（1）、CLASSLESS QDisc(不可分类QDisc)"></a>（1）、CLASSLESS QDisc(不可分类QDisc)</h4><h5 id="1-无类别QDISC包括："><a href="#1-无类别QDISC包括：" class="headerlink" title="1. 无类别QDISC包括："></a>1. 无类别QDISC包括：</h5><p>　　<strong>[p|b]fifo</strong></p>
<p>　　使用最简单的qdisc，纯粹的先进先出。只有一个参数：limit，用来设置队列的长度,pfifo是以数据包的个数为单位；bfifo是以字节数为单位。</p>
<p>　　<strong>pfifo_fast</strong></p>
<p>　　在编译内核时，如果打开了高级路由器(Advanced Router)编译选项，pfifo_fast就是系统的标准QDISC。它的队列包括三个波段(band)。在每个波段里面，使用先进先出规则。而三个波段(band)的优先级也不相同，band 0的优先级最高，band 2的最低。如果band里面有数据包，系统就不会处理band 1里面的数据包，band 1和band 2之间也是一样。数据包是按照服务类型(Type of Service,TOS)被分配多三个波段(band)里面的。</p>
<p>　　<strong>red</strong></p>
<p>　　red是Random Early Detection(随机早期探测)的简写。如果使用这种QDISC，当带宽的占用接近于规定的带宽时，系统会随机地丢弃一些数据包。它非常适合高带宽应用。</p>
<p>　　<strong>sfq</strong></p>
<p>　　sfq是Stochastic Fairness Queueing的简写。它按照会话(session–对应于每个TCP连接或者UDP流)为流量进行排序，然后循环发送每个会话的数据包。</p>
<p>　　<strong>tbf</strong></p>
<p>　　tbf是Token Bucket Filter的简写，适合于把流速降低到某个值。</p>
<h5 id="2-不可分类QDisc的配置"><a href="#2-不可分类QDisc的配置" class="headerlink" title="2. 不可分类QDisc的配置"></a>2. 不可分类QDisc的配置</h5><p>　　如果没有可分类QDisc，不可分类QDisc只能附属于设备的根。它们的用法如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc qdisc add dev DEV root QDISC QDISC-PARAMETERS</div></pre></td></tr></table></figure>
<p>　　要删除一个不可分类QDisc，需要使用如下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc qdisc del dev DEV root</div></pre></td></tr></table></figure>
<p>　　一个网络接口上如果没有设置QDisc，pfifo_fast就作为缺省的QDisc。</p>
<h4 id="（2）、CLASSFUL-QDISC-分类QDisc"><a href="#（2）、CLASSFUL-QDISC-分类QDisc" class="headerlink" title="（2）、CLASSFUL QDISC(分类QDisc)"></a>（2）、CLASSFUL QDISC(分类QDisc)</h4><h5 id="可分类的QDisc包括："><a href="#可分类的QDisc包括：" class="headerlink" title="可分类的QDisc包括："></a>可分类的QDisc包括：</h5><p>　　<strong>CBQ</strong></p>
<p>　　CBQ是Class Based Queueing(基于类别排队)的缩写。它实现了一个丰富的连接共享类别结构，既有限制(shaping)带宽的能力，也具有带宽优先级管理的能力。带宽限制是通过计算连接的空闲时间完成的。空闲时间的计算标准是数据包离队事件的频率和下层连接(数据链路层)的带宽。</p>
<p>　　<strong>HTB</strong></p>
<p>　　HTB是Hierarchy Token Bucket的缩写。通过在实践基础上的改进，它实现了一个丰富的连接共享类别体系。使用HTB可以很容易地保证每个类别的带宽，虽然它也允许特定的类可以突破带宽上限，占用别的类的带宽。HTB可以通过TBF(Token Bucket Filter)实现带宽限制，也能够划分类别的优先级。</p>
<p>　　<strong>PRIO</strong></p>
<p>　　PRIO QDisc不能限制带宽，因为属于不同类别的数据包是顺序离队的。使用PRIO QDisc可以很容易对流量进行优先级管理，只有属于高优先级类别的数据包全部发送完毕，才会发送属于低优先级类别的数据包。为了方便管理，需要使用iptables或者ipchains处理数据包的服务类型(Type Of Service,ToS)。</p>
<h3 id="CLASS-类"><a href="#CLASS-类" class="headerlink" title="CLASS(类)"></a>CLASS(类)</h3><p>　　某些QDisc(排队规则)可以包含一些类别，不同的类别中可以包含更深入的QDisc(排队规则)，通过这些细分的QDisc还可以为进入的队列的数据包排队。通过设置各种类别数据包的离队次序，QDisc可以为设置网络数据流量的优先级。</p>
<h3 id="FILTER-过滤器"><a href="#FILTER-过滤器" class="headerlink" title="FILTER(过滤器)"></a>FILTER(过滤器)</h3><p>　　Filter(过滤器)用于为数据包分类，决定它们按照何种QDisc进入队列。无论何时数据包进入一个划分子类的类别中，都需要进行分类。分类的方法可以有多种，使用fileter(过滤器)就是其中之一。使用filter(过滤器)分类时，内核会调用附属于这个类(class)的所有过滤器，直到返回一个判决。如果没有判决返回，就作进一步的处理，而处理方式和QDISC有关。需要注意的是，filter(过滤器)是在QDisc内部，它们不能作为主体。</p>
<h2 id="2-3、操作原理"><a href="#2-3、操作原理" class="headerlink" title="2.3、操作原理"></a>2.3、操作原理</h2><p>　　类(Class)组成一个树，每个类都只有一个父类，而一个类可以有多个子类。某些QDisc(例如：CBQ和HTB)允许在运行时动态添加类，而其它的QDisc(例如：PRIO)不允许动态建立类。允许动态添加类的QDisc可以有零个或者多个子类，由它们为数据包排队。此外，每个类都有一个叶子QDisc，默认情况下，这个叶子QDisc使用pfifo的方式排队，我们也可以使用其它类型的QDisc代替这个默认的QDisc。而且，这个叶子叶子QDisc有可以分类，不过每个子类只能有一个叶子QDisc。 当一个数据包进入一个分类QDisc，它会被归入某个子类。</p>
<p>　　我们可以使用以下三种方式为数据包归类，不过不是所有的QDisc都能够使用这三种方式：</p>
<ul>
<li>tc过滤器(tc filter)</li>
</ul>
<p>　　如果过滤器附属于一个类，相关的指令就会对它们进行查询。过滤器能够匹配数据包头所有的域，也可以匹配由ipchains或者iptables做的标记。</p>
<ul>
<li>服务类型(Type of Service)</li>
</ul>
<p>　　某些QDisc有基于服务类型（Type of Service,ToS）的内置的规则为数据包分类。</p>
<ul>
<li>skb-&gt;priority</li>
</ul>
<p>　　用户空间的应用程序可以使用SO_PRIORITY选项在skb-&gt;priority域设置一个类的ID。</p>
<p>　　树的每个节点都可以有自己的过滤器，但是高层的过滤器也可以直接用于其子类。</p>
<p>　　如果数据包没有被成功归类，就会被排到这个类的叶子QDisc的队中。相关细节在各个QDisc的手册页中。</p>
<h2 id="2-4、命名规则"><a href="#2-4、命名规则" class="headerlink" title="2.4、命名规则"></a>2.4、命名规则</h2><p>　　所有的QDisc、类和过滤器都有ID。ID可以手工设置，也可以有内核自动分配。ID由一个主序列号和一个从序列号组成，两个数字用一个冒号分开。</p>
<p>　　<strong>QDISC</strong></p>
<p>　　一个QDisc会被分配一个主序列号，叫做句柄(handle)，然后把从序列号作为类的命名空间。句柄采用象10:一样的表达方式。习惯上，需要为有子类的QDisc显式地分配一个句柄。</p>
<p>　　<strong>类(CLASS)</strong></p>
<p>　　在同一个QDisc里面的类分享这个QDisc的主序列号，但是每个类都有自己的从序列号，叫做类识别符(classid)。类识别符只与父QDisc有关，和父类无关。类的命名习惯和QDisc的相同。</p>
<p>　　<strong>过滤器(FILTER)</strong></p>
<p>　　过滤器的ID有三部分，只有在对过滤器进行散列组织才会用到。详情请参考tc-filters手册页。</p>
<h2 id="2-5、单位"><a href="#2-5、单位" class="headerlink" title="2.5、单位"></a>2.5、单位</h2><p>　　tc命令的所有参数都可以使用浮点数，可能会涉及到以下计数单位。</p>
<table>
<thead>
<tr>
<th>带宽或者流速单位：</th>
</tr>
</thead>
<tbody>
<tr>
<td>kbps</td>
<td>千字节/秒</td>
</tr>
<tr>
<td>mbps</td>
<td>兆字节/秒</td>
</tr>
<tr>
<td>kbit</td>
<td>KBits/秒</td>
</tr>
<tr>
<td>mbit</td>
<td>MBits/秒</td>
</tr>
<tr>
<td>bps或者一个无单位数字</td>
<td>字节数/秒</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>数据的数量单位：</th>
</tr>
</thead>
<tbody>
<tr>
<td>kb或者k</td>
<td>千字节</td>
</tr>
<tr>
<td>mb或者m</td>
<td>兆字节</td>
</tr>
<tr>
<td>mbit</td>
<td>兆bit</td>
</tr>
<tr>
<td>kbit</td>
<td>千bit</td>
</tr>
<tr>
<td>b或者一个无单位数字</td>
<td>字节数</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>时间的计量单位：</th>
</tr>
</thead>
<tbody>
<tr>
<td>s、sec或者secs</td>
<td>秒</td>
</tr>
<tr>
<td>ms、msec或者msecs</td>
<td>分钟</td>
</tr>
<tr>
<td>us、usec、usecs或者一个无单位数字</td>
<td>微秒</td>
</tr>
</tbody>
</table>
<h1 id="三、TC命令"><a href="#三、TC命令" class="headerlink" title="三、TC命令"></a>三、TC命令</h1><p>　　tc可以使用以下命令对QDisc、类和过滤器进行操作：</p>
<ul>
<li>add</li>
</ul>
<p>　　在一个节点里加入一个QDisc、类或者过滤器。添加时，需要传递一个祖先作为参数，传递参数时既可以使用ID也可以直接传递设备的根。如果要建立一个QDisc或者过滤器，可以使用句柄(handle)来命名；如果要建立一个类，可以使用类识别符(classid)来命名。</p>
<ul>
<li>remove</li>
</ul>
<p>　　删除有某个句柄(handle)指定的QDisc，根QDisc(root)也可以删除。被删除QDisc上的所有子类以及附属于各个类的过滤器都会被自动删除。</p>
<ul>
<li>change</li>
</ul>
<p>　　以替代的方式修改某些条目。除了句柄(handle)和祖先不能修改以外，change命令的语法和add命令相同。换句话说，change命令不能一定节点的位置。</p>
<ul>
<li>replace</li>
</ul>
<p>　　对一个现有节点进行近于原子操作的删除/添加。如果节点不存在，这个命令就会建立节点。</p>
<ul>
<li>link</li>
</ul>
<p>　　只适用于DQisc，替代一个现有的节点。</p>
<h1 id="四、具体操作"><a href="#四、具体操作" class="headerlink" title="四、具体操作"></a>四、具体操作</h1><p>　　Linux流量控制主要分为建立队列、建立分类和建立过滤器三个方面。</p>
<h2 id="4-1、基本实现步骤为："><a href="#4-1、基本实现步骤为：" class="headerlink" title="4.1、基本实现步骤为："></a>4.1、基本实现步骤为：</h2><ul>
<li>（1） 针对网络物理设备（如以太网卡eth0）绑定一个队列QDisc；</li>
<li>（2） 在该队列上建立分类class；</li>
<li>（3） 为每一分类建立一个基于路由的过滤器filter；</li>
<li>（4） 最后与过滤器相配合，建立特定的路由表。</li>
</ul>
<h2 id="4-2、环境模拟实例"><a href="#4-2、环境模拟实例" class="headerlink" title="4.2、环境模拟实例:"></a>4.2、环境模拟实例:</h2><p>　　流量控制器上的以太网卡(eth0) 的IP地址为192.168.1.66，在其上建立一个CBQ队列。假设包的平均大小为1000字节，包间隔发送单元的大小为8字节，可接收冲突的发送最长包数目为20字节。</p>
<p>　　假如有三种类型的流量需要控制: </p>
<ol>
<li>是发往主机1的，其IP地址为192.168.1.24。其流量带宽控制在8Mbit，优先级为2；</li>
<li>是发往主机2的，其IP地址为192.168.1.30。其流量带宽控制在1Mbit，优先级为1；</li>
<li>是发往子网1的，其子网号为192.168.1.0，子网掩码为255.255.255.0。流量带宽控制在1Mbit，优先级为6。</li>
</ol>
<h3 id="1-建立队列"><a href="#1-建立队列" class="headerlink" title="1. 建立队列"></a>1. 建立队列</h3><p>　　一般情况下，针对一个网卡只需建立一个队列。</p>
<p>　　将一个cbq队列绑定到网络物理设备eth0上，其编号为1:0；网络物理设备eth0的实际带宽为10 Mbit，包的平均大小为1000字节；包间隔发送单元的大小为8字节，最小传输包大小为64字节。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc qdisc add dev eth0 root handle 1: cbq bandwidth 10Mbit avpkt 1000 cell 8 mpu 64</div></pre></td></tr></table></figure>
<h3 id="2-建立分类"><a href="#2-建立分类" class="headerlink" title="2. 建立分类"></a>2. 建立分类</h3><p>　　分类建立在队列之上。</p>
<p>　　一般情况下，针对一个队列需建立一个根分类，然后再在其上建立子分类。对于分类，按其分类的编号顺序起作用，编号小的优先；一旦符合某个分类匹配规则，通过该分类发送数据包，则其后的分类不再起作用。</p>
<p>　　<strong>1） 创建根分类1:1；分配带宽为10Mbit，优先级别为8。</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc class add dev eth0 parent 1:0 classid 1:1 cbq bandwidth 10Mbit rate 10Mbit maxburst 20 allot 1514 prio 8 avpkt 1000 cell 8 weight 1Mbit</div></pre></td></tr></table></figure>
<p>　　该队列的最大可用带宽为10Mbit，实际分配的带宽为10Mbit，可接收冲突的发送最长包数目为20字节；最大传输单元加MAC头的大小为1514字节，优先级别为8，包的平均大小为1000字节，包间隔发送单元的大小为8字节，相应于实际带宽的加权速率为1Mbit。</p>
<p>　　<strong>2）创建分类1:2，其父分类为1:1，分配带宽为8Mbit，优先级别为2。</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc class add dev eth0 parent 1:1 classid 1:2 cbq bandwidth 10Mbit rate 8Mbit maxburst 20 allot 1514 prio 2 avpkt 1000 cell 8 weight 800Kbit split 1:0 bounded</div></pre></td></tr></table></figure>
<p>　　该队列的最大可用带宽为10Mbit，实际分配的带宽为 8Mbit，可接收冲突的发送最长包数目为20字节；最大传输单元加MAC头的大小为1514字节，优先级别为1，包的平均大小为1000字节，包间隔发送单元的大小为8字节，相应于实际带宽的加权速率为800Kbit，分类的分离点为1:0，且不可借用未使用带宽。</p>
<p>　　<strong>3）创建分类1:3，其父分类为1:1，分配带宽为1Mbit，优先级别为1。</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc class add dev eth0 parent 1:1 classid 1:3 cbq bandwidth 10Mbit rate 1Mbit maxburst 20 allot 1514 prio 1 avpkt 1000 cell 8 weight 100Kbit split 1:0</div></pre></td></tr></table></figure>
<p>　　该队列的最大可用带宽为10Mbit，实际分配的带宽为 1Mbit，可接收冲突的发送最长包数目为20字节；最大传输单元加MAC头的大小为1514字节，优先级别为2，包的平均大小为1000字节，包间隔发送单元的大小为8字节，相应于实际带宽的加权速率为100Kbit，分类的分离点为1:0。</p>
<p>　　<strong>4）创建分类1:4，其父分类为1:1，分配带宽为1Mbit，优先级别为6。</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc class add dev eth0 parent 1:1 classid 1:4 cbq bandwidth 10Mbit rate 1Mbit maxburst 20 allot 1514 prio 6 avpkt 1000 cell 8 weight 100Kbit split 1:0</div></pre></td></tr></table></figure>
<p>　　该队列的最大可用带宽为10Mbit，实际分配的带宽为1Mbit，可接收冲突的发送最长包数目为20字节；最大传输单元加MAC头的大小为1514字节，优先级别为6，包的平均大小为1000字节，包间隔发送单元的大小为8字节，相应于实际带宽的加权速率为100Kbit，分类的分离点为1:0。</p>
<h2 id="4-3-建立过滤器"><a href="#4-3-建立过滤器" class="headerlink" title="4.3. 建立过滤器"></a>4.3. 建立过滤器</h2><p>　　过滤器主要服务于分类。</p>
<p>一般只需针对根分类提供一个过滤器，然后为每个子分类提供路由映射。</p>
<p><strong>1） 应用路由分类器到cbq队列的根，父分类编号为1:0；过滤协议为ip，优先级别为100，过滤器为基于路由表。</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc filter add dev eth0 parent 1:0 protocol ip prio 100 route</div></pre></td></tr></table></figure>
<p><strong>2） 建立路由映射分类1:2, 1:3, 1:4</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tc filter add dev eth0 parent 1:0 protocol ip prio 100 route to 2 flowid 1:2</div><div class="line"></div><div class="line">tc filter add dev eth0 parent 1:0 protocol ip prio 100 route to 3 flowid 1:3</div><div class="line"></div><div class="line">tc filter add dev eth0 parent 1:0 protocol ip prio 100 route to 4 flowid 1:4</div></pre></td></tr></table></figure>
<h2 id="4-4-建立路由"><a href="#4-4-建立路由" class="headerlink" title="4.4.建立路由"></a>4.4.建立路由</h2><p>　　该路由是与前面所建立的路由映射一一对应。</p>
<p>　　<strong>1） 发往主机192.168.1.24的数据包通过分类2转发(分类2的速率8Mbit)</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip route add 192.168.1.24 dev eth0 via 192.168.1.66 realm 2</div></pre></td></tr></table></figure>
<p>　　<strong>2） 发往主机192.168.1.30的数据包通过分类3转发(分类3的速率1Mbit)</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip route add 192.168.1.30 dev eth0 via 192.168.1.66 realm 3</div></pre></td></tr></table></figure>
<p>　　<strong>3）发往子网192.168.1.0/24的数据包通过分类4转发(分类4的速率1Mbit)</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip route add 192.168.1.0/24 dev eth0 via 192.168.1.66 realm 4</div></pre></td></tr></table></figure>
<p>　　<strong>注</strong>：一般对于流量控制器所直接连接的网段建议使用IP主机地址流量控制限制，不要使用子网流量控制限制。如一定需要对直连子网使用子网流量控制限制，则在建立该子网的路由映射前，需将原先由系统建立的路由删除，才可完成相应步骤。</p>
<h2 id="4-5-监视"><a href="#4-5-监视" class="headerlink" title="4.5. 监视"></a>4.5. 监视</h2><p>　　主要包括对现有队列、分类、过滤器和路由的状况进行监视。</p>
<p>　　<strong>1）显示队列的状况</strong></p>
<p>　　简单显示指定设备(这里为eth0)的队列状况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tc qdisc ls dev eth0</div><div class="line"></div><div class="line">qdisc cbq 1: rate 10Mbit (bounded,isolated) prio no-transmit</div></pre></td></tr></table></figure>
<p>　　详细显示指定设备(这里为eth0)的队列状况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc -s qdisc ls dev eth0</div></pre></td></tr></table></figure>
<p>　　这里主要显示了通过该队列发送了13232个数据包，数据流量为7646731个字节，丢弃的包数目为0，超过速率限制的包数目为0。</p>
<p>　　<strong>2）显示分类的状况</strong></p>
<p>　　简单显示指定设备(这里为eth0)的分类状况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc class ls dev eth0</div></pre></td></tr></table></figure>
<p>　　详细显示指定设备(这里为eth0)的分类状况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc -s class ls dev eth0</div></pre></td></tr></table></figure>
<p>　　这里主要显示了通过不同分类发送的数据包，数据流量，丢弃的包数目，超过速率限制的包数目等等。其中根分类(class cbq 1:0)的状况应与队列的状况类似。</p>
<p>　　例如，分类class cbq 1:4发送了8076个数据包，数据流量为5552879个字节，丢弃的包数目为0，超过速率限制的包数目为0。</p>
<p>　　<strong>3）显示过滤器的状况</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc -s filter ls dev eth0</div></pre></td></tr></table></figure>
<p>　　这里flowid 1:2代表分类class cbq 1:2，to 2代表通过路由2发送。</p>
<p>　　<strong>4）显示现有路由的状况</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ip route</div></pre></td></tr></table></figure>
<p>　　如上所示，结尾包含有realm的显示行是起作用的路由过滤器。</p>
<h1 id="五、实例脚本"><a href="#五、实例脚本" class="headerlink" title="五、实例脚本"></a>五、实例脚本</h1><h2 id="5-1-tc限速"><a href="#5-1-tc限速" class="headerlink" title="5.1 tc限速"></a>5.1 tc限速</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/sh</span></div><div class="line"></div><div class="line">touch  /var/lock/subsys/<span class="built_in">local</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span>  1  &gt; /proc/sys/net/ipv4/ip_forward （激活转发）</div><div class="line"></div><div class="line">route add default  gw  10.0.0.0  (这是加入电信网关，如果你已设了不用这条）</div><div class="line"></div><div class="line">DOWNLOAD=640Kbit        (640/8 =80K ,我这里限制下载最高速度只能80K）</div><div class="line">UPLOAD=640Kbit          (640/8 =80K,上传速度也限制在80K）</div><div class="line">INET=192.168.0.         (设置网段，根据你的情况填）</div><div class="line">IPS=1                   (这个意思是从192.168.0.1开始）</div><div class="line">IPE=200                 (我这设置是从IP为192.168.0.1-200这个网段限速，根据自已的需要改）</div><div class="line">ServerIP=253            (网关IP）</div><div class="line">IDEV=eth0</div><div class="line">ODEV=eth1</div><div class="line"></div><div class="line">/sbin/tc  qdisc  del  dev  <span class="variable">$IDEV</span> root handle 10:</div><div class="line">/sbin/tc  qdisc  del  dev  <span class="variable">$ODEV</span>  root handle  20:</div><div class="line">/sbin/tc  qdisc  add  dev <span class="variable">$IDEV</span>  root  handle  10: cbq  bandwidth  100Mbit avpkt  1000</div><div class="line">/sbin/tc  qdisc  add  dev  <span class="variable">$ODEV</span>  root  handle  20: cbq bandwidth  1Mbit  avpkt  1000</div><div class="line">/sbin/tc  class  add  dev <span class="variable">$IDEV</span>  parent 10:0  classid  10:1  cbq  bandwidth  100Mbit  rate 100Mbit  allot 1514  weight  1Mbit  prio  8  maxburst  20  avpkt  1000</div><div class="line">/sbin/tc  class  add  dev  <span class="variable">$ODEV</span>  parent  20:0  classid  20:1 cbq  bandwidth  1Mbit  rate  1Mbit  allot  1514  weitht  10Kbit  prio  8  maxburst  20  avpkt  1000</div><div class="line"></div><div class="line">COUNTER=<span class="variable">$IPS</span></div><div class="line"><span class="keyword">while</span>  [  <span class="variable">$COUNTER</span>  -le  <span class="variable">$IPE</span>  ]</div><div class="line">    <span class="keyword">do</span></div><div class="line">/sbin/tc  class  add  dev  <span class="variable">$IDEV</span>  parent  10:1  classid  10:1<span class="variable">$COUNTER</span>  cbq  banwidth  100Mbit  rate  </div><div class="line"><span class="variable">$DOWNLOAD</span>  allot  1514  weight  20Kbit  prio  5  maxburst  20  avpkt  1000  bounded</div><div class="line">/sbin/tc  qdisc  add  dev  <span class="variable">$IDEV</span>  parent  10:1<span class="variable">$COUNTER</span>  sfq  quantum  1514b  perturb15</div><div class="line"></div><div class="line">/sbin/tc  filter  add  dev  <span class="variable">$IDEV</span>  parent  10:0  protocol  ip  prio  100  u32  match  ipdst  <span class="variable">$INET</span><span class="variable">$COUNTER</span>  flowid  10:1<span class="variable">$COUNTER</span></div><div class="line">      COUNTER=` expr  <span class="variable">$COUNTER</span>  +  1  `</div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line">iptables  -t  nat  -A  POSTROUTING  -o  eth1  <span class="_">-s</span>  192.168.0.0/24  -J  MASQUERADE</div></pre></td></tr></table></figure>
<h2 id="5-2-模型"><a href="#5-2-模型" class="headerlink" title="5.2 模型"></a>5.2 模型</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">tc qdisc del dev eth7 root &amp;&gt; /dev/null</div><div class="line">tc qdisc del dev eth8 root &amp;&gt; /dev/null</div><div class="line"></div><div class="line"><span class="comment">#Add qdisc</span></div><div class="line">tc qdisc add dev eth7 root handle 10: htb default 9998</div><div class="line">tc qdisc add dev eth8 root handle 10: htb default 9998</div><div class="line"></div><div class="line"><span class="comment">#Add htb root node</span></div><div class="line">tc class add dev eth7 parent 10: classid 10:9999 htb rate 1000000kbit ceil 1000000kbit</div><div class="line">tc class add dev eth8 parent 10: classid 10:9999 htb rate 1000000kbit ceil 1000000kbit</div><div class="line"></div><div class="line"><span class="comment">#Add htb fake default node here</span></div><div class="line">tc class add dev eth7 parent 10:9999 classid 10:9998 htb rate 1000000kbit ceil 1000000kbit</div><div class="line">tc class add dev eth8 parent 10:9999 classid 10:9998 htb rate 1000000kbit ceil 1000000kbit</div><div class="line"></div><div class="line"><span class="comment">#Add rule node</span></div><div class="line">tc class add dev eth7 parent 10:9999 classid 10:3 htb rate 1kbit ceil 50kbit</div><div class="line">tc filter add dev eth7 parent 10: protocol ip handle 3 fw classid 10:3</div><div class="line">tc class add dev eth8 parent 10:9999 classid 10:3 htb rate 1kbit ceil 50kbit</div><div class="line">tc filter add dev eth8 parent 10: protocol ip handle 3 fw classid 10:3</div><div class="line"></div><div class="line"><span class="comment">#Add htb real default node here</span></div><div class="line">tc class change dev eth7 classid 10:9998 htb rate 1kbit ceil 1000000kbit</div><div class="line">tc class change dev eth8 classid 10:9998 htb rate 1kbit ceil 1000000kbit</div></pre></td></tr></table></figure>
<h2 id="5-3-限制一个IP上传下载速度"><a href="#5-3-限制一个IP上传下载速度" class="headerlink" title="5.3 限制一个IP上传下载速度"></a>5.3 限制一个IP上传下载速度</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#  tc uses the following units when passed as a parameter.</span></div><div class="line"><span class="comment">#  kbps: Kilobytes per second</span></div><div class="line"><span class="comment">#  mbps: Megabytes per second</span></div><div class="line"><span class="comment">#  kbit: Kilobits per second</span></div><div class="line"><span class="comment">#  mbit: Megabits per second</span></div><div class="line"><span class="comment">#  bps: Bytes per second</span></div><div class="line"><span class="comment">#       Amounts of data can be specified in:</span></div><div class="line"><span class="comment">#       kb or k: Kilobytes</span></div><div class="line"><span class="comment">#       mb or m: Megabytes</span></div><div class="line"><span class="comment">#       mbit: Megabits</span></div><div class="line"><span class="comment">#       kbit: Kilobits</span></div><div class="line"><span class="comment">#  To get the byte figure from bits, divide the number by 8 bit</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Name of the traffic control command.</span></div><div class="line">TC=/sbin/tc</div><div class="line"></div><div class="line"><span class="comment"># The network interface we're planning on limiting bandwidth.</span></div><div class="line">IF=em1             <span class="comment"># Interface</span></div><div class="line"></div><div class="line"><span class="comment"># Download limit (in mega bits)</span></div><div class="line">DNLD=80mbit          <span class="comment"># DOWNLOAD Limit</span></div><div class="line"></div><div class="line"><span class="comment"># Upload limit (in mega bits)</span></div><div class="line">UPLD=80mbit          <span class="comment"># UPLOAD Limit</span></div><div class="line"></div><div class="line"><span class="comment"># IP address of the machine we are controlling</span></div><div class="line">IP=125.64.15.21     <span class="comment"># Host IP</span></div><div class="line"></div><div class="line"><span class="comment"># Filter options for limiting the intended interface.</span></div><div class="line">U32=<span class="string">"<span class="variable">$TC</span> filter add dev <span class="variable">$IF</span> protocol ip parent 1:0 prio 1 u32"</span></div><div class="line"></div><div class="line"><span class="function"><span class="title">start</span></span>() &#123;</div><div class="line"></div><div class="line"><span class="comment"># We'll use Hierarchical Token Bucket (HTB) to shape bandwidth.</span></div><div class="line"><span class="comment"># For detailed configuration options, please consult Linux man</span></div><div class="line"><span class="comment"># page.</span></div><div class="line"></div><div class="line">    <span class="variable">$TC</span> qdisc add dev <span class="variable">$IF</span> root handle 1: htb default 30</div><div class="line">    <span class="variable">$TC</span> class add dev <span class="variable">$IF</span> parent 1: classid 1:1 htb rate <span class="variable">$DNLD</span></div><div class="line">    <span class="variable">$TC</span> class add dev <span class="variable">$IF</span> parent 1: classid 1:2 htb rate <span class="variable">$UPLD</span></div><div class="line">    <span class="variable">$U32</span> match ip dst <span class="variable">$IP</span>/32 flowid 1:1</div><div class="line">    <span class="variable">$U32</span> match ip src <span class="variable">$IP</span>/32 flowid 1:2</div><div class="line"></div><div class="line"><span class="comment"># The first line creates the root qdisc, and the next two lines</span></div><div class="line"><span class="comment"># create two child qdisc that are to be used to shape download</span></div><div class="line"><span class="comment"># and upload bandwidth.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># The 4th and 5th line creates the filter to match the interface.</span></div><div class="line"><span class="comment"># The 'dst' IP address is used to limit download speed, and the</span></div><div class="line"><span class="comment"># 'src' IP address is used to limit upload speed.</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">stop</span></span>() &#123;</div><div class="line"></div><div class="line"><span class="comment"># Stop the bandwidth shaping.</span></div><div class="line">    <span class="variable">$TC</span> qdisc del dev <span class="variable">$IF</span> root</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">restart</span></span>() &#123;</div><div class="line"></div><div class="line"><span class="comment"># Self-explanatory.</span></div><div class="line">    stop</div><div class="line">    sleep 1</div><div class="line">    start</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">show</span></span>() &#123;</div><div class="line"></div><div class="line"><span class="comment"># Display status of traffic control status.</span></div><div class="line">    <span class="variable">$TC</span> <span class="_">-s</span> qdisc ls dev <span class="variable">$IF</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line"></div><div class="line">  start)</div><div class="line"></div><div class="line">    <span class="built_in">echo</span> -n <span class="string">"Starting bandwidth shaping: "</span></div><div class="line">    start</div><div class="line">    <span class="built_in">echo</span> <span class="string">"done"</span></div><div class="line">    ;;</div><div class="line"></div><div class="line">  stop)</div><div class="line"></div><div class="line">    <span class="built_in">echo</span> -n <span class="string">"Stopping bandwidth shaping: "</span></div><div class="line">    stop</div><div class="line">    <span class="built_in">echo</span> <span class="string">"done"</span></div><div class="line">    ;;</div><div class="line"></div><div class="line">  restart)</div><div class="line"></div><div class="line">    <span class="built_in">echo</span> -n <span class="string">"Restarting bandwidth shaping: "</span></div><div class="line">    restart</div><div class="line">    <span class="built_in">echo</span> <span class="string">"done"</span></div><div class="line">    ;;</div><div class="line"></div><div class="line">  show)</div><div class="line"></div><div class="line">    <span class="built_in">echo</span> <span class="string">"Bandwidth shaping status for <span class="variable">$IF</span>:"</span></div><div class="line">    show</div><div class="line">    <span class="built_in">echo</span> <span class="string">""</span></div><div class="line">    ;;</div><div class="line"></div><div class="line">  *)</div><div class="line"></div><div class="line">    <span class="built_in">pwd</span>=$(<span class="built_in">pwd</span>)</div><div class="line">    <span class="built_in">echo</span> <span class="string">"Usage: tc.bash &#123;start|stop|restart|show&#125;"</span></div><div class="line">    ;;</div><div class="line"></div><div class="line"><span class="keyword">esac</span></div><div class="line"></div><div class="line"><span class="built_in">exit</span> 0</div></pre></td></tr></table></figure>
<p>本文原文出处:<a href="http://leslie-chu.blog.163.com/blog/static/19986324320125414618221" target="_blank" rel="external">http://leslie-chu.blog.163.com/blog/static/19986324320125414618221</a></p>
<p>主要参考（所有权利归原文作者所有）：</p>
<p><a href="http://www.cnblogs.com/endsock/archive/2011/12/09/2281519.html" target="_blank" rel="external">http://www.cnblogs.com/endsock/archive/2011/12/09/2281519.html</a></p>
<p><a href="http://blog.163.com/ninja_wk/blog/static/989155620084280154811/" target="_blank" rel="external">http://blog.163.com/ninja_wk/blog/static/989155620084280154811/</a></p>
<p><a href="http://www.chinaunix.net/jh/4/16110.html" target="_blank" rel="external">http://www.chinaunix.net/jh/4/16110.html</a></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a rel="external nofollow" href="/2017/05/28/service/tc命令Linux基于IP进行流量限速/">tc命令——Linux基于IP进行流量限速</a></p>
        <p><span>文章作者:</span><a rel="external nofollow" href="/" title="访问 Linux运维装逼指南 的个人博客">Linux运维装逼指南</a></p>
        <p><span>发布时间:</span>2017年05月28日 - 13时18分</p>
        <p><span>最后更新:</span>2017年05月28日 - 13时28分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/05/28/service/tc命令Linux基于IP进行流量限速/" title="tc命令——Linux基于IP进行流量限速">http://www.unix-like.com/2017/05/28/service/tc命令Linux基于IP进行流量限速/</a>
            <span class="copy-path" data-clipboard-text="原文: http://www.unix-like.com/2017/05/28/service/tc命令Linux基于IP进行流量限速/　　作者: Linux运维装逼指南" title=""></span>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a rel="external nofollow" href="/2017/05/28/life/运维人装逼指南大全/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          运维人装逼指南大全
        
      </div>
    </a>
  
  
    <a rel="external nofollow" href="/2017/05/27/system/Linux上ssd优化/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Linux上ssd优化</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、TC原理"><span class="toc-number">1.</span> <span class="toc-text">一、TC原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、TC规则"><span class="toc-number">2.</span> <span class="toc-text">二、TC规则</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1、流量控制方式"><span class="toc-number">2.1.</span> <span class="toc-text">2.1、流量控制方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2、流量控制处理对象"><span class="toc-number">2.2.</span> <span class="toc-text">2.2、流量控制处理对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#QDISC-排队规则"><span class="toc-number">2.2.1.</span> <span class="toc-text">QDISC(排队规则)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#（1）、CLASSLESS-QDisc-不可分类QDisc"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">（1）、CLASSLESS QDisc(不可分类QDisc)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-无类别QDISC包括："><span class="toc-number">2.2.1.1.1.</span> <span class="toc-text">1. 无类别QDISC包括：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-不可分类QDisc的配置"><span class="toc-number">2.2.1.1.2.</span> <span class="toc-text">2. 不可分类QDisc的配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（2）、CLASSFUL-QDISC-分类QDisc"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">（2）、CLASSFUL QDISC(分类QDisc)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#可分类的QDisc包括："><span class="toc-number">2.2.1.2.1.</span> <span class="toc-text">可分类的QDisc包括：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CLASS-类"><span class="toc-number">2.2.2.</span> <span class="toc-text">CLASS(类)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FILTER-过滤器"><span class="toc-number">2.2.3.</span> <span class="toc-text">FILTER(过滤器)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3、操作原理"><span class="toc-number">2.3.</span> <span class="toc-text">2.3、操作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4、命名规则"><span class="toc-number">2.4.</span> <span class="toc-text">2.4、命名规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5、单位"><span class="toc-number">2.5.</span> <span class="toc-text">2.5、单位</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、TC命令"><span class="toc-number">3.</span> <span class="toc-text">三、TC命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四、具体操作"><span class="toc-number">4.</span> <span class="toc-text">四、具体操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1、基本实现步骤为："><span class="toc-number">4.1.</span> <span class="toc-text">4.1、基本实现步骤为：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2、环境模拟实例"><span class="toc-number">4.2.</span> <span class="toc-text">4.2、环境模拟实例:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-建立队列"><span class="toc-number">4.2.1.</span> <span class="toc-text">1. 建立队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-建立分类"><span class="toc-number">4.2.2.</span> <span class="toc-text">2. 建立分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-建立过滤器"><span class="toc-number">4.3.</span> <span class="toc-text">4.3. 建立过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-建立路由"><span class="toc-number">4.4.</span> <span class="toc-text">4.4.建立路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-监视"><span class="toc-number">4.5.</span> <span class="toc-text">4.5. 监视</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五、实例脚本"><span class="toc-number">5.</span> <span class="toc-text">五、实例脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-tc限速"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 tc限速</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-模型"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-限制一个IP上传下载速度"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 限制一个IP上传下载速度</span></a></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="/js/require-2.1.6-jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>








    



    <div class="scroll" id="post-nav-button">
        
            <a rel="external nofollow" href="/2017/05/28/life/运维人装逼指南大全/" title="上一篇: 运维人装逼指南大全">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a rel="external nofollow" href="/2017/05/27/system/Linux上ssd优化/" title="下一篇: Linux上ssd优化">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/06/09/database/用innobackup备份恢复mysql/">用innobackup备份恢复mysql</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/service/linux下添加redis扩展/">linux下添加redis扩展</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/service/tomcat软件部署及项目部署脚本/">Tomcat环境搭建及配置规范</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/database/mongodb线上线下同步备份脚步/">mongodb线上线下同步备份脚步</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/08/database/mysql线上线下同步备份脚步/">mysql线上线下同步备份脚步</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/07/service/Linux服务器iptables配置/">Linux服务器iptables配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/service/在Ubuntu15.04上配置OpenVPN服务器和客户端/">Ubuntu 15.04 上配置 OpenVPN 服务器和客户端</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/service/Ubuntu下OpenVPN客户端配置/">Ubuntu下OpenVPN客户端配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/04/service/KVM部署及虚拟机安装/">kvm部署及虚拟机安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/02/system/使用命令行生成高强度密码/">使用命令行生成高强度密码</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/31/system/LINUX下解决netstat查看TIME-WAIT状态过多问题/">LINUX下解决netstat查看TIME_WAIT状态过多问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/31/service/logrotate切割日志nginx和php配置/">logrotate切割日志nginx和php配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/31/service/nginx常见问题/">nginx常见问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/30/system/恢复linux被误删文件/">恢复linux被误删文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/30/service/修改PHP上传文件大小限制/">修改PHP上传文件大小限制</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/29/service/ Windows与Linux共享文件夹互相访问 /">Windows与Linux共享文件夹互相访问</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/28/life/系统运维工程师装逼完全指南/">系统运维工程师装逼完全指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/28/life/运维人装逼指南大全/">运维人装逼指南大全</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/28/service/tc命令Linux基于IP进行流量限速/">tc命令——Linux基于IP进行流量限速</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/27/system/Linux上ssd优化/">Linux上ssd优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/26/service/rsync安装配置实例/">rsync安装配置实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/system/pdflush进程详解与优化/">pdflush进程详解与优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/database/MongoDB归档及压缩工具/">MongoDB归档及压缩工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/system/Linux下清空或删除大文件内容的5种方法/">Linux下清空或删除大文件内容的5种方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/database/redis模糊删除key/">redis模糊删除key</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/system/Linux查看文件编码格式及文件编码转换/">Linux查看文件编码格式及文件编码转换</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/25/system/Bash历史中执行过的每一项命令设置时间和日期/">Bash历史中执行过的每一项命令设置时间和日期.md</a></li></ul>
    <script src="/js/require-2.1.6-jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        // $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2017 Linux运维装逼指南
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a><a href="https://github.com/maochunguang" target="_blank">Blog</a> by tommy
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >极客到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="/css/require-2.1.6-jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 1;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>






<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>


<script async src="/js/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>